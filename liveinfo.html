<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CrabbyFlight — Live Overlay (Firebase)</title>
<style>
  :root{
    --bg:#1d1f22; --panel:#2a2d31; --ink:#f2f3f5; --muted:#b5bcc6; --line:#3a3f46;
    --brand:#FFD100; --accent:#FFA500; --shadow:0 8px 24px rgba(0,0,0,.28);
    --radius:14px; --gap:16px;
  }

  /* Page transparent for OBS; editor retains dark bg */
  html, body {
    margin:0; padding:0; height:100%;
    background: transparent !important;
    color: var(--ink);
    font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  }
  body.editor { background: var(--bg); }

  /* ===== Editor (app) ===== */
  .wrap{ max-width:980px; margin:0 auto; padding:28px; background:var(--bg);}
  .card{ background:var(--panel); border:1px solid var(--line); border-radius:var(--radius);
    padding:18px; margin:14px 0; box-shadow:var(--shadow);}
  h1{ margin:0 0 14px; font-size:26px; font-weight:700; letter-spacing:.2px;}
  label{ display:block; font-size:12px; font-weight:600; color:var(--muted); margin:6px 0 6px }
  input,select{ width:100%; background:#32363c; border:1px solid #444a52; color:var(--ink);
    border-radius:12px; padding:10px 14px; height:44px; box-sizing:border-box; outline:none; -webkit-appearance:none; appearance:none;}
  input:focus,select:focus{ border-color:#5b9cff; box-shadow:0 0 0 3px rgba(91,156,255,.18) }
  .grid{ display:grid; grid-template-columns:1fr 1fr; gap:var(--gap) }
  .btns{ display:flex; gap:10px; flex-wrap:wrap; margin-top:14px; }
  button{ border:1px solid #454b54; background:#373c43; color:var(--ink); padding:10px 14px;
    border-radius:12px; cursor:pointer; transition:background .15s ease, transform .02s ease;}
  button:hover{ background:#3f454d } button:active{ transform:translateY(1px) }
  .hint{ color:var(--muted); font-size:12px; }

  /* ===== INFO overlay ===== */
  .container { position:absolute; top:24px; left:24px; }
  .info-box {
    background: rgba(44,48,54,0.62);
    border: 1px solid rgba(61,67,75,0.85);
    box-shadow: var(--shadow);
    border-radius: 12px;
    color:#fff; font-family:inherit; font-size:18px;
    padding:12px 18px; line-height:1.4; text-align:left; display:inline-block;
    min-width:480px;
    text-shadow:2px 2px 4px rgba(0,0,0,0.9);
    backdrop-filter: blur(2px);
  }
  .plane-icon { vertical-align: middle; margin: 0 5px; transform: rotate(90deg); width: 16px; height: 16px; }
  @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.4); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }
  @keyframes flashText { 0%, 50%, 100% { opacity: 1; } 25%, 75% { opacity: 0.6; } }
  .live-indicator { display: inline-flex; align-items: center; gap: 5px; }
  .live-dot { width: 10px; height: 10px; background-color: red; border-radius: 50%; display: inline-block; animation: pulse 1s infinite; }
  .live-text { color: red; font-weight: bold; animation: flashText 1s infinite; }
  .dynamic { color: #FFA500; font-weight: bold; text-shadow:2px 2px 4px rgba(0,0,0,0.9); }
  .top-row { display: flex; align-items: center; margin-bottom: 5px; }
  .airport-info { display: flex; align-items: center; gap: 5px; }
  .flight-info { display: flex; align-items: center; gap: 8px; font-weight: normal; }
  .flight-label { color: white; text-shadow:2px 2px 4px rgba(0,0,0,0.9); }
  .separator-diamond { width: 6px; height: 6px; background: white; transform: rotate(45deg); display: inline-block; margin: 0 8px; }
  .bottom-row { display: flex; align-items: center; gap: 5px; flex-wrap: wrap; margin-top: 3px; }

  /* ===== DEPARTURES board (unchanged) ===== */
  .board { position:absolute; top:32px; left:32px; min-width:760px; border-radius:12px; overflow:hidden;
    box-shadow:var(--shadow); background:#2c3036; border:1px solid #3d434b }
  .header { background:#FFD100; color:#000; display:flex; align-items:center; gap:10px;
    font-weight:800; letter-spacing:.3px; padding:12px 18px; font-size:22px; position:relative; overflow:hidden }
  .header svg { width:22px; height:22px; }
  .header::after{ content:""; position:absolute; top:0; left:-45%; width:40%; height:100%; pointer-events:none;
    background:linear-gradient(120deg, rgba(255,209,0,0) 0%, rgba(255,209,0,0.45) 50%, rgba(255,209,0,0) 100%);
    filter:blur(1px); animation:hdrSweep 4s linear infinite }
  @keyframes hdrSweep{ 0%{ transform:translateX(0) } 100%{ transform:translateX(250%) } }

  .table { display:grid; grid-template-columns:96px 1fr 1fr 120px 72px 188px; column-gap:14px;
    padding:10px 18px 14px; font-size:17px; color:#fff }
  .th,.tr{ display:contents; }
  .th span { color:#cfcfcf; padding:8px 0 6px; border-bottom:1px solid rgba(255,255,255,0.20);
    text-transform:uppercase; font-size:14px; letter-spacing:.8px; }
  .cell{ padding:10px 0; border-bottom:1px solid rgba(255,255,255,0.08); min-height:44px; display:flex; align-items:center }

  .status{ display:inline-flex; align-items:center; gap:8px; padding:4px 12px; border-radius:999px;
    font-weight:700; font-size:13px; letter-spacing:.3px; background:#31363d; border:1px solid #3f454d }
  .dot{ width:8px; height:8px; border-radius:50%; background:#999; }
  .on-time{ color:#00ff90 } .on-time .dot{ background:#00ff90 }
  .boarding{ color:#4dd2ff } .boarding .dot{ background:#4dd2ff }
  .delayed{ color:#ffb84d } .delayed .dot{ background:#ffb84d }
  .cancelled{ color:#ff4d4d } .cancelled .dot{ background:#ff4d4d }
  .sideways{ color:#FFA500 } .sideways .dot{ background:#FFA500 }
  .status.custom{ color:#5b9cff } .status.custom .dot{ background:#5b9cff }

  .tr.real{ position:relative; }
  .tr.real .cell{ background:linear-gradient(90deg,rgba(255,165,0,0.12),rgba(255,165,0,0)); }
  .tr.real::before{
    content:""; position:absolute; left:-25%; top:0; height:100%; width:20%;
    background:linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,.12), rgba(255,255,255,0));
    filter:blur(2px); transform:skewX(-8deg); animation:rowSheen 6s linear infinite;
  }
  @keyframes rowSheen { 0%{ transform:translateX(0) skewX(-8deg) } 100%{ transform:translateX(650%) skewX(-8deg) } }
  .real .flight{ color:#FFA500; font-weight:800; }
  .real .from,.real .to{ color:#FFA500; font-weight:700; }
  .muted{ color:#cfcfcf; }
  .footer{ display:flex; justify-content:flex-end; gap:24px; padding:10px 18px 16px; color:#cfcfcf; font-size:16px; flex-wrap:nowrap; white-space:nowrap; text-shadow:2px 2px 4px rgba(0,0,0,0.7); }
  .footer strong{ color:#fff; }

  /* Visibility modes */
  body.editor #screen-editor{ display:block }
  body.editor #screen-info, body.editor #screen-departures{ display:none }
  body.info #screen-info{ display:block }
  body.info #screen-editor, body.info #screen-departures{ display:none }
  body.departures #screen-departures{ display:block }
  body.departures #screen-editor, body.departures #screen-info{ display:none }
  /* Overlays run on transparent bg in OBS */
  body.info, body.departures { background: transparent; }
</style>
</head>
<body>

<!-- ============== EDITOR ============== -->
<div id="screen-editor" class="wrap">
  <h1>CrabbyFlight — Overlay Editor (Firebase)</h1>
  <div class="card">
    <div class="grid">
      <div><label>From</label><input id="from" placeholder="Oslo (ENGM)"></div>
      <div><label>To</label><input id="to" placeholder="Liverpool (EGGP)"></div>
    </div>
    <div class="grid">
      <div><label>Flight</label><input id="flight" placeholder="POR9392"></div>
      <div><label>Callsign</label><input id="callsign" placeholder="WALL13"></div>
    </div>
    <div class="grid">
      <div><label>Gate (Departures)</label><input id="gate" placeholder="B12"></div>
      <div>
        <label>Status (Departures)</label>
        <select id="status">
          <option value="on-time">ON TIME</option>
          <option value="boarding">BOARDING</option>
          <option value="delayed">DELAYED</option>
          <option value="cancelled">CANCELLED</option>
          <option value="sideways">SIDEWAYS</option>
          <option value="custom">Custom…</option>
        </select>
      </div>
    </div>

    <div class="grid" id="customRow" style="display:none">
      <div><label>Custom status text</label><input id="status_custom" placeholder="e.g. DIVERTED TO EDI"></div>
      <div><label>&nbsp;</label><input disabled value="Shown on the board as blue badge"></div>
    </div>

    <div class="grid">
      <div><label>Departure UTC</label><input id="dep_utc" placeholder="14:30 UTC"></div>
      <div><label>Arrival UTC</label><input id="arr_utc" placeholder="16:30 UTC"></div>
    </div>
    <div class="grid">
      <div><label>Aircraft (Info)</label><input id="aircraft" placeholder="A320neo"></div>
      <div><label>Cruise (Info)</label><input id="cruise" placeholder="35,000ft"></div>
    </div>
    <div class="grid">
      <div><label>Time en route (Info)</label><input id="enroute" placeholder="~2hrs"></div>
      <div><label>LIVE</label>
        <select id="live"><option value="on">On</option><option value="off">Off</option></select>
      </div>
    </div>

    <div class="btns">
      <button id="openInfo">Open Info (#info)</button>
      <button id="openDep">Open Departures (#departures)</button>
      <button id="copyUrls">Copy Overlay URLs</button>
      <span class="hint">Use the same room ID. You can add <code>?x</code>, <code>?y</code>, <code>?scale</code> to position/size overlays.</span>
    </div>
  </div>
  <div class="card"><div class="hint">In OBS Browser Source, point to this file with <code>#info:ROOM</code> or <code>#departures:ROOM</code>.</div></div>
</div>

<!-- ============== INFO OVERLAY ============== -->
<div id="screen-info" class="container">
  <div class="info-box">
    <div class="top-row">
      <div class="airport-info">
        <span class="dynamic" id="i_from">Oslo (ENGM)</span>
        <svg class="plane-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M21 16v-2l-8-5V3.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5V9l-8 5v2l8-1v4l-2 .5v1l3-1 3 1v-1l-2-.5v-4l8 1z"/></svg>
        <span class="dynamic" id="i_to">Liverpool (EGGP)</span>
      </div>
      <span class="separator-diamond"></span>
      <div class="flight-info">
        <span class="flight-label">Flight:</span> <span class="dynamic" id="i_flight">POR9392</span> |
        <span class="flight-label">Callsign:</span> <span class="dynamic" id="i_callsign">WALL13</span>
      </div>
    </div>

    <div class="bottom-row">
      <strong>Aircraft:</strong> <span class="dynamic" id="i_aircraft">A320neo</span> |
      <strong>Cruise:</strong> <span class="dynamic" id="i_cruise">35,000ft</span> |
      Time en route: <span class="dynamic" id="i_enroute">~2hrs</span>
    </div>

    <div class="bottom-row" style="margin-top:3px; gap:10px;">
      <span class="live-indicator" id="i_live_block"><span class="live-dot"></span><span class="live-text">LIVE</span></span>
      1080p30FPS | macOS + OneCast
    </div>
  </div>
</div>

<!-- ============== DEPARTURES BOARD ============== -->
<div id="screen-departures" class="board">
  <div class="header">
    <svg viewBox="0 0 24 24" fill="black"><path d="M2.5 19h19v2h-19zM3.87 9.91l4.12 1.28 4.75-4.89 1.88.59-2.91 6.83 7.23 2.25c.53.17.87.64.87 1.2 0 .82-.79 1.41-1.57 1.17L.69 12.38l.53-1.96 2.65-.51z"/></svg>
    DEPARTURES
  </div>

  <div class="table">
    <div class="th">
      <span>Time</span><span>From</span><span>To</span><span>Flight</span><span>Gate</span><span>Status</span>
    </div>

    <!-- Fun sample rows -->
    <div class="tr">
      <div class="cell">13:55</div><div class="cell">Springfield (SPFD)</div><div class="cell">Shelbyville (SHBY)</div><div class="cell">SPF101</div><div class="cell">A07</div>
      <div class="cell"><span class="status on-time"><span class="dot"></span>ON TIME</span></div>
    </div>
    <div class="tr">
      <div class="cell">14:05</div><div class="cell">Gotham (GTHM)</div><div class="cell">Metropolis (MTRP)</div><div class="cell">BAT247</div><div class="cell">C03</div>
      <div class="cell"><span class="status delayed"><span class="dot"></span>DELAYED 12 MIN</span></div>
    </div>

    <!-- Your real dynamic row -->
    <div class="tr real">
      <div class="cell" id="d_time">14:30</div>
      <div class="cell from" id="d_from">Oslo (ENGM)</div>
      <div class="cell to" id="d_to">Liverpool (EGGP)</div>
      <div class="cell flight" id="d_flight">POR9392</div>
      <div class="cell gate" id="d_gate">B12</div>
      <div class="cell">
        <span class="status on-time" id="d_status"><span class="dot"></span><span id="d_status_text">ON TIME</span></span>
      </div>
    </div>

    <!-- More sample rows -->
    <div class="tr">
      <div class="cell">15:10</div><div class="cell">Area 51 (????)</div><div class="cell">Roswell (RSWL)</div><div class="cell">UFO001</div><div class="cell">X99</div>
      <div class="cell"><span class="status boarding"><span class="dot"></span>BOARDING</span></div>
    </div>
    <div class="tr">
      <div class="cell">15:25</div><div class="cell">Atlantis (ATLS)</div><div class="cell">Bermuda (BRMD)</div><div class="cell">SEA404</div><div class="cell">D21</div>
      <div class="cell"><span class="status cancelled"><span class="dot"></span>CANCELLED</span></div>
    </div>
  </div>

  <div class="footer">
    <div><span class="muted">Time en route:</span> <strong id="d_enroute">~2 hrs</strong></div>
    <div><span class="muted">Departure:</span> <strong id="d_dep">14:30 UTC</strong></div>
    <div><span class="muted">Arrival:</span> <strong id="d_arr">16:30 UTC</strong></div>
  </div>
</div>

<script type="module">
  const firebaseConfig = {
    apiKey: "AIzaSyBs4FN-KgUH7cQl15BFyCSLGGq-O-Ey4u0",
    authDomain: "crabbyflight.firebaseapp.com",
    databaseURL: "https://crabbyflight-default-rtdb.firebaseio.com",
    projectId: "crabbyflight",
    storageBucket: "crabbyflight.firebasestorage.app",
    messagingSenderId: "741648861487",
    appId: "1:741648861487:web:583ec0887f5ac3dce079da",
    measurementId: "G-8PZNG3Y1CE"
  };
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";
  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);

  if (!location.hash) { location.replace('#editor:room1'); }

  function parseHash(){
    const raw = (location.hash||'').replace(/^#/, '');
    const [mode, room] = raw.split(':');
    return { mode: (mode||'editor').toLowerCase(), room: room||'room1' };
  }
  let { mode, room } = parseHash();
  function applyMode(){
    document.body.classList.remove('editor','info','departures');
    document.body.classList.add(mode);
  }
  applyMode();
  window.addEventListener('hashchange', ()=>{ ({mode, room}=parseHash()); applyMode(); bind(); });

  const FIELDS = ["from","to","flight","callsign","gate","status","status_custom","dep_utc","arr_utc","aircraft","cruise","enroute","live"];
  const DEFAULTS = { from:"Oslo (ENGM)", to:"Liverpool (EGGP)", flight:"POR9392", callsign:"WALL13", gate:"B12",
    status:"on-time", status_custom:"", dep_utc:"14:30 UTC", arr_utc:"16:30 UTC",
    aircraft:"A320neo", cruise:"35,000ft", enroute:"~2hrs", live:"on" };

  function bindEditor(){
    const els = Object.fromEntries(FIELDS.map(id=>[id, document.getElementById(id)]));
    const statusEl = els['status'];
    const customRow = document.getElementById('customRow');

    function read(){ const d={}; for(const k of FIELDS){ d[k] = (els[k]?.value||'').trim(); } return d; }
    let t=null; function save(){ clearTimeout(t); t=setTimeout(()=>set(ref(db, `rooms/${room}`), read()), 120); }
    for(const k of FIELDS){ const el=els[k]; if(!el) continue; el.addEventListener('input', save); el.addEventListener('change', save); }

    function toggleCustom(){ if(customRow) customRow.style.display = (statusEl?.value==='custom') ? 'grid' : 'none'; }
    if (statusEl){ statusEl.addEventListener('change', toggleCustom); toggleCustom(); }

    document.getElementById('openInfo').onclick = ()=> window.open(`#info:${room}${location.search}`, '_blank');
    document.getElementById('openDep').onclick  = ()=> window.open(`#departures:${room}${location.search}`, '_blank');

    const copyBtn = document.getElementById('copyUrls');
    if (copyBtn) copyBtn.onclick = async ()=>{
      const base = location.href.split('#')[0];
      const qs = location.search || '';
      const lines = [
        `Editor:      ${base}#editor:${room}${qs}`,
        `Info:        ${base}#info:${room}${qs}`,
        `Departures:  ${base}#departures:${room}${qs}`
      ].join('\\n');
      try{ await navigator.clipboard.writeText(lines); copyBtn.textContent='Copied!'; setTimeout(()=>copyBtn.textContent='Copy Overlay URLs',1500); }catch{ alert(lines); }
    };
  }

  function renderInfo(d){
    const v=(k,def='')=>(d?.[k]||'').trim()||def;
    const setT=(id,val)=>{ const el=document.getElementById(id); if(el) el.textContent=val; };
    setT('i_from',v('from',DEFAULTS.from)); setT('i_to',v('to',DEFAULTS.to));
    setT('i_flight',v('flight',DEFAULTS.flight)); setT('i_callsign',v('callsign',DEFAULTS.callsign));
    setT('i_aircraft',v('aircraft',DEFAULTS.aircraft)); setT('i_cruise',v('cruise',DEFAULTS.cruise)); setT('i_enroute',v('enroute',DEFAULTS.enroute));
    const live = v('live','on')==='on'; const blk=document.getElementById('i_live_block'); if(blk) blk.style.display = live?'inline-flex':'none';
  }

  function renderDepartures(d){
    const v=(k,def='')=>(d?.[k]||'').trim()||def;
    const setT=(id,val)=>{ const el=document.getElementById(id); if(el) el.textContent=val; };
    setT('d_from',v('from',DEFAULTS.from)); setT('d_to',v('to',DEFAULTS.to));
    setT('d_flight',v('flight',DEFAULTS.flight)); setT('d_gate',v('gate',DEFAULTS.gate));
    setT('d_dep',v('dep_utc',DEFAULTS.dep_utc)); setT('d_arr',v('arr_utc',DEFAULTS.arr_utc)); setT('d_enroute',v('enroute',DEFAULTS.enroute));
    setT('d_time',v('dep_utc',DEFAULTS.dep_utc).replace(' UTC',''));

    const st=v('status','on-time'); const node=document.getElementById('d_status');
    if(st==='custom'){ if(node) node.className='status custom'; const txt=v('status_custom','STATUS');
      const stTxt=document.getElementById('d_status_text'); if(stTxt) stTxt.textContent=txt; return; }
    const labels={ 'on-time':'ON TIME','boarding':'BOARDING','delayed':'DELAYED','cancelled':'CANCELLED','sideways':'SIDEWAYS' };
    if(node) node.className='status '+st;
    const stTxt=document.getElementById('d_status_text'); if(stTxt) stTxt.textContent=labels[st]||st.toUpperCase();
  }

  function subscribe(){
    const r = ref(db, `rooms/${room}`);
    onValue(r, snap=>{
      const data = snap.val() || DEFAULTS;
      if (mode==='info') renderInfo(data);
      if (mode==='departures') renderDepartures(data);
      if (mode==='editor') {
        for(const k of FIELDS){ const el=document.getElementById(k); if(el && typeof data[k]==='string'){ el.value=data[k]; } }
        const statusEl=document.getElementById('status'); const customRow=document.getElementById('customRow');
        if(statusEl && customRow) customRow.style.display = (statusEl.value==='custom') ? 'grid':'none';
      }
    });
  }

  function applyOverlayOptions(){
    const usp=new URLSearchParams(location.search);
    const x=parseFloat(usp.get('x')||''); const y=parseFloat(usp.get('y')||''); const s=parseFloat(usp.get('scale')||''); const onlyReal=usp.get('onlyReal');
    const place=(el)=>{ if(!el) return; if(!Number.isNaN(x)) el.style.left=x+'px'; if(!Number.isNaN(y)) el.style.top=y+'px';
      if(!Number.isNaN(s)) el.style.transform=`scale(${s})`; el.style.transformOrigin='top left'; };
    if (mode==='info') place(document.querySelector('#screen-info .info-box').parentElement);
    if (mode==='departures') place(document.getElementById('screen-departures'));
    if (mode==='departures' && (onlyReal==='1'||onlyReal==='true')){
      document.querySelectorAll('.table .tr').forEach(tr=>{ if(!tr.classList.contains('real') && !tr.previousElementSibling?.classList.contains('th')) tr.style.display='none'; });
    }
  }

  window.addEventListener('keydown', (e)=>{
    if((mode==='info'||mode==='departures') && (e.key==='e'||e.key==='E')){
      const base=location.href.split('#')[0]; location.href = `${base}#editor:${room}`;
    }
  });

  function bind(){ if (mode==='editor') bindEditor(); subscribe(); applyOverlayOptions(); }
  bind();
</script>
</body>
</html>
