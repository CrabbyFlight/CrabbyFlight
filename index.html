<!-- /index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CrabbyFlight — Live Overlay (Firebase)</title>

<link rel="icon" type="image/png" sizes="32x32" href="logo192.png">
<link rel="apple-touch-icon" href="logo192.png">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1d1f22">
<meta name="apple-mobile-web-app-title" content="CrabbyFlight">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<script>
  (function () {
    const raw = (location.hash || '').replace(/^#/, '');
    const mode = (raw.split(':')[0] || 'editor').toLowerCase();
    document.addEventListener('DOMContentLoaded', () => document.body.classList.add(mode || 'editor'));
    const standalone = matchMedia('(display-mode: standalone)').matches || navigator.standalone;
    // why: avoid deadlock—don’t show splash on editor; it may never mark "ready" when signed-out
    if (standalone && (mode === 'info' || mode === 'departures' || mode === 'frame')) {
      document.documentElement.classList.add('standalone');
    }
  })();
</script>

<style>
  :root{
    --bg:#1c1e22; --panel:#24272c; --line:#32363c; --text:#e7eaee; --muted:#a7b0bd; --accent:#9ad0ff;
    --radius:14px; --gap:16px;
  }
  html,body{height:100%}
  body{
    margin:0; background:#1c1e22; color:var(--text); font:14px/1.35 -apple-system,BlinkMacSystemFont,Segoe UI,Inter,Roboto,Helvetica,Arial,sans-serif;
    display:grid; place-items:stretch; grid-template-rows: auto 1fr; 
  }
  #screen-editor,#screen-info,#screen-departures,#screen-auth,#screen-frame{display:none}
  body.editor #screen-editor{display:block}
  body.info #screen-info{display:block}
  body.departures #screen-departures{display:block}
  body.frame #screen-frame{display:block}
  body.auth #screen-auth{display:block}
  .top{
    display:flex; align-items:center; gap:12px; padding:10px 14px; background:linear-gradient(to bottom, #1b1d21, #17191c);
    border-bottom:1px solid #2b2f34; position:sticky; top:0; z-index:10;
  }
  .brand{display:flex; align-items:center; gap:10px; font-weight:600}
  .brand img{width:20px;height:20px;border-radius:4px}
  .top .spacer{flex:1}
  .top .nav a{color:#aab3bf;text-decoration:none;margin:0 8px;padding:6px 10px;border-radius:8px;border:1px solid transparent}
  .top .nav a:hover{background:#22262b;border-color:#2d333b}
  .wrap{max-width:980px;margin:20px auto;padding:0 16px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:18px;margin:14px 0;box-shadow:var(--shadow)}
  h1{margin:0 0 14px;font-size:26px;font-weight:700;letter-spacing:.2px}
  label{display:block;font-size:12px;font-weight:600;color:var(--muted);margin:6px 0 6px}
  input,select{width:100%;background:#32363c;border:1px solid #454b54;color:var(--text);border-radius:10px;padding:11px 10px;height:44px;box-sizing:border-box;outline:none;appearance:none}
  input:focus,select:focus{border-color:#5b9cff;box-shadow:0 0 0 3px rgba(91,156,255,.18)}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap)}
  .btns{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:14px}
  button{border:1px solid #454b54;background:#373c43;color:var(--text);border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer;transition:background .15s ease,transform .02s ease}
  button:hover{background:#3f454d} button:active{transform:translateY(1px)}
  .hint{color:var(--muted);font-size:12px}
  .pill{display:inline-block;padding:4px 10px;font-size:12px;border-radius:999px;background:#31363d;border:1px solid #3f454d}
  .ok{color:#00d58a} .warn{color:#ffb84d}

  /* Auth */
  #screen-auth .auth-wrap{max-width:420px;margin:40px auto}
  .auth-logo{display:grid;place-items:center}
  .auth-logo img{width:120px;height:120px;border-radius:16px;background:#17191c;border:1px solid #2a2e34}
  .auth-actions{display:flex;gap:10px;justify-content:center;margin:10px 0}
  .auth-status{font-size:12px;color:#9fb5cc;text-align:center}

  /* Info overlay */
  #screen-info{
    display:grid;place-items:center;height:calc(100vh - 64px); 
  }
  #screen-info .overlay{
    width:min(100%,1080px); height:min(100%,200px); background:#17191c;border:1px solid #2a2e34;border-radius:12px;
    display:grid; grid-template-columns: 1fr 1fr 1fr; gap:14px; align-items:center; padding:16px;
  }

  /* Departure board overlay */
  #screen-departures .board{width:min(100%,1080px);margin:14px auto;border:1px solid #2a2e34;border-radius:12px;background:#17191c}
  #screen-departures .row{display:grid;grid-template-columns:140px 1fr 120px 120px 120px 120px;gap:10px;padding:8px 12px;border-top:1px solid #22262c}
  #screen-departures .row.head{background:#1d2025;border-top:none;font-weight:700;color:#9eb1c7}
  #screen-departures .row .badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #31405a;background:#203048}

  /* Frame */
  #screen-frame .frame{display:grid;place-items:center;height:calc(100vh - 60px)}
  #screen-frame .frame .box{width:min(100%,1080px);height:min(100%,720px);background:#0c0f13;border:1px solid #2a2e34;border-radius:12px}

  @media (max-width:720px){
    .grid{grid-template-columns:1fr}
  }
</style>
</head>
<body class="editor">
  <div class="top">
    <div class="brand"><img src="logo192.png" alt=""><div class="label">CrabbyFlight</div></div>
    <div class="spacer"></div>
    <div class="nav">
      <a href="#editor">Editor</a>
      <a href="#info">Info overlay</a>
      <a href="#departures">Departure board</a>
      <a href="#frame">Frame</a>
      <a href="#auth">Auth</a>
    </div>
  </div>

<!-- AUTH -->
<div id="screen-auth">
  <div class="auth-wrap">
    <div class="card" style="text-align:center">
      <div class="auth-logo">
        <!-- why: show brand; graceful fallback -->
        <img src="logo.png" alt="CrabbyFlight" onerror="this.onerror=null; this.src='logo192.png'">
      </div>
      <label>Email</label><input id="auth_email" type="email" inputmode="email" autocomplete="username" placeholder="you@example.com">
      <label>Password</label><input id="auth_password" type="password" autocomplete="current-password" placeholder="••••••••">
      <div class="auth-actions">
        <button id="btn_signin">Sign in</button>
        <button id="btn_signup" title="Create an account for yourself">Sign up</button>
      </div>
      <div class="auth-status" id="auth_status"></div>
    </div>
    <div class="card">
      <span class="pill" id="net_badge">Status: checking…</span>
    </div>
  </div>
</div>

<!-- EDITOR -->
<div id="screen-editor" class="wrap">
  <h1>CrabbyFlight — Overlay Editor (Firebase)</h1>

  <!-- SimBrief (read-only) -->
  <div class="card" id="simbrief_card">
    <h3 style="margin:0 0 10px;font-size:18px">SimBrief Import</h3>
    <div class="grid">
      <div><label>SimBrief User ID</label><input id="simbrief_userid" placeholder="e.g. 1234567"></div>
      <div><label>&nbsp;</label><button id="sb_fetch_btn" title="Fetch latest OFP by User ID">Fetch from SimBrief</button></div>
    </div>
    <div class="hint">Read-only. Populates the fields below (From, To, Flight, Callsign, Aircraft, Airframe, Enroute, Departure UTC, Arrival UTC). Overlays remain untouched.</div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px;font-size:18px">Basic Flight Info</h3>
    <div class="grid">
      <div><label>From</label><input id="from" placeholder="Oslo (ENGM)"></div>
      <div><label>To</label><input id="to" placeholder="Liverpool (EGGP)"></div>
    </div>
    <div class="grid">
      <div><label>Flight</label><input id="flight" placeholder="POR9392"></div>
      <div><label>Callsign</label><input id="callsign" placeholder="WALL13"></div>
    </div>
    <div class="grid">
      <div><label>Gate (Departures)</label><input id="gate" placeholder="B12"></div>
      <div>
        <label>Status (Departures)</label>
        <select id="status">
          <option value="on-time">ON TIME</option>
          <option value="boarding">BOARDING</option>
          <option value="delayed">DELAYED</option>
          <option value="cancelled">CANCELLED</option>
          <option value="sideways">SIDEWAYS</option>
          <option value="custom">Custom…</option>
        </select>
      </div>
    </div>

    <div class="grid" id="customRow" style="display:none">
      <div><label>Custom status text</label><input id="status_custom" placeholder="e.g. DIVERTED TO EDI"></div>
      <div><label>&nbsp;</label><input disabled value="Shown on the board as blue badge"></div>
    </div>

    <div class="grid">
      <div><label>Departure UTC</label><input id="dep_utc" placeholder="14:30 UTC"></div>
      <div><label>Arrival UTC</label><input id="arr_utc" placeholder="16:30 UTC"></div>
    </div>
    <div class="grid">
      <div><label>Aircraft (Info)</label><input id="aircraft" placeholder="A320neo"></div>
      <div><label>Cruise (Info)</label><input id="cruise" placeholder="35,000ft"></div>
    </div>
    <div class="grid">
      <div><label>Time en route (Info)</label><input id="enroute" placeholder="~2hrs"></div>
      <div><label>LIVE</label>
        <select id="live"><option value="on">On</option><option value="off">Off</option></select>
      </div>
    
    <div class="card" style="margin-top:10px">
      <h3 style="margin:0 0 10px;font-size:18px">Frame (Webcam) Settings</h3>
      <div class="grid">
        <div><label>Webcam Size</label>
          <select id="webcam_size"><option value="md">Medium</option><option value="sm">Small</option><option value="lg">Large</option></select>
        </div>
        <div><label>Stroke</label><input id="stroke" placeholder="1-20"></div>
      </div>
      <div class="grid">
        <div><label>Corner Radius</label><input id="radius" placeholder="0-32"></div>
        <div><label>Blur</label><input id="blur" placeholder="0-20"></div>
      </div>
      <div class="grid">
        <div><label>Title (Info)</label><input id="title" placeholder="e.g. AER LINGUS A320neo ✈️"></div>
        <div><label>SubTitle (Info)</label><input id="subtitle" placeholder="e.g. Oslo ➜ Liverpool"></div>
      </div>
      <div class="btns">
        <button id="btn_copy_info">Copy Info URL</button>
        <button id="btn_copy_dep">Copy Departures URL</button>
        <button id="btn_copy_frame">Copy Frame URL</button>
      </div>
    </div>
  </div>
</div>

<!-- INFO OVERLAY (unchanged) -->
<div id="screen-info">
  <div class="overlay wrap">
    <!-- your existing info overlay layout stays as-is -->
    <div class="card">Info overlay preview…</div>
  </div>
</div>

<!-- DEPARTURE BOARD OVERLAY (unchanged) -->
<div id="screen-departures" class="wrap">
  <div class="board">
    <div class="row head"><div>TIME</div><div>FROM/TO</div><div>FLIGHT</div><div>GATE</div><div>STATUS</div><div>REMARKS</div></div>
    <div class="row"><div>—</div><div>—</div><div>—</div><div>—</div><div class="badge">ON TIME</div><div>—</div></div>
  </div>
</div>

<!-- FRAME (unchanged) -->
<div id="screen-frame" class="wrap">
  <div class="frame"><div class="box"></div></div>
</div>

<!-- SimBrief import (read-only; safe) -->
<script>
// === CrabbyFlight x SimBrief (read-only import) ===
(function(){
  const BASE = "https://www.simbrief.com/api/xml.fetcher.php";
  const ELS = {
    from:    document.getElementById("from"),
    to:      document.getElementById("to"),
    flight:  document.getElementById("flight"),
    callsign:document.getElementById("callsign"),
    aircraft:document.getElementById("aircraft"),
    airframe:document.getElementById("airframe") || null,
    enroute: document.getElementById("enroute"),
    dep_utc: document.getElementById("dep_utc"),
    arr_utc: document.getElementById("arr_utc"),
  };

  function setValue(el, v){
    if(!el) return;
    const val = v == null ? "" : String(v);
    if (el.value === val) return;
    el.value = val;
    el.dispatchEvent(new Event("input", {bubbles:true}));
    el.dispatchEvent(new Event("change", {bubbles:true}));
  }

  function num(v){
    if(v==null) return null;
    const n = Number(String(v).replace(/[, ]/g,""));
    return Number.isFinite(n) ? n : null;
  }

  function minutesDiff(isoOrHM1, isoOrHM2){
    const parseHM = (s)=>{
      if(!s) return null;
      // HH:MM, assume Z
      const m = String(s).match(/^(\d{1,2}):(\d{2})/);
      if(m){
        const d = new Date();
        d.setUTCHours(Number(m[1]), Number(m[2]), 0, 0);
        return d;
      }
      const d = new Date(s);
      return isNaN(d) ? null : d;
    };
    const a = parseHM(isoOrHM1), b = parseHM(isoOrHM2);
    if(!a || !b) return null;
    return Math.round((b - a) / 60000);
  }

  function fmtEte(mins){
    if(mins==null) return "";
    const h = Math.floor(mins/60);
    const m = Math.round(mins%60);
    return (h>0? h+"h ":"") + String(m).padStart(2,"0")+"m";
  }

  async function fetchOfpByUserId(userId){
    const tryJson = await fetch(`${BASE}?userid=${encodeURIComponent(userId)}&json=1`);
    if(tryJson.ok){
      const ofp = await tryJson.json().catch(()=>null);
      if(ofp) return { kind: "json", ofp };
    }
    const res = await fetch(`${BASE}?userid=${encodeURIComponent(userId)}`);
    if(!res.ok) throw new Error(`SimBrief: ${res.status} ${res.statusText}`);
    const xmlTxt = await res.text();
    const xml = new DOMParser().parseFromString(xmlTxt, "application/xml");
    return { kind: "xml", ofp: xml };
  }

  function norm(ofp, kind){
    if(kind === "json"){
      const g=ofp.general||{}, a=ofp.aircraft||{}, atc=ofp.atc||{}, o=ofp.origin||{}, d=ofp.destination||{}, t=ofp.times||{}, f=ofp.fuel||{}, w=ofp.weights||{};
      return {
        from: o.name || o.plan_rwy || o.icao_code || o.icao || "",
        to: d.name || d.plan_rwy || d.icao_code || d.icao || "",
        flight: g.flight_number || g.icao_airline || "",
        callsign: atc.callsign || g.callsign || "",
        aircraft: a.icao_code || a.icao || a.type || "",
        airframe: a.reg || a.registration || "",
        dep_utc: g.deptime || g.etd || t.deptime || "",
        arr_utc: g.arrtime || g.eta || t.arrtime || "",
        enroute: t.enroute_time || t.ete || t.block_time || ""
      };
    } else {
      const q=(s)=> ofp.querySelector(s)?.textContent?.trim() || "";
      return {
        from: q("origin name") || q("origin icao_code") || q("origin icao"),
        to: q("destination name") || q("destination icao_code") || q("destination icao"),
        flight: q("general flight_number") || q("general icao_airline"),
        callsign: q("atc callsign") || q("general callsign"),
        aircraft: q("aircraft icao_code") || q("aircraft icao") || q("aircraft type"),
        airframe: q("aircraft reg") || q("aircraft registration"),
        dep_utc: q("general deptime") || q("general etd") || q("times deptime"),
        arr_utc: q("general arrtime") || q("general eta") || q("times arrtime"),
        enroute: q("times enroute_time") || q("times ete") || q("times block_time")
      };
    }
  }

  async function applyFromInput(){
    const userId = (document.getElementById("simbrief_userid")||{}).value?.trim();
    if(!userId){ alert("Enter SimBrief User ID"); return; }
    try{
      const {kind, ofp} = await fetchOfpByUserId(userId);
      const data = norm(ofp, kind);
      // If enroute missing, compute from dep/arr
      if(!data.enroute){
        const mins = minutesDiff(data.dep_utc, data.arr_utc);
        if(mins!=null) data.enroute = fmtEte(mins);
      }
      setValue(ELS.from, data.from);
      setValue(ELS.to, data.to);
      setValue(ELS.flight, data.flight);
      setValue(ELS.callsign, data.callsign);
      setValue(ELS.aircraft, data.aircraft);
      setValue(ELS.airframe, data.airframe);
      setValue(ELS.enroute, data.enroute);
      setValue(ELS.dep_utc, data.dep_utc);
      setValue(ELS.arr_utc, data.arr_utc);
    } catch (e){
      console.warn("SimBrief fetch failed", e);
      alert("SimBrief fetch failed: " + (e && e.message || e));
    }
  }

  document.addEventListener("DOMContentLoaded", function(){
    const btn = document.getElementById("sb_fetch_btn");
    if(btn){ btn.addEventListener("click", applyFromInput); }
  });
})();
</script>

</body>
</html>
