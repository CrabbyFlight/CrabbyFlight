<!-- /index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CrabbyFlight — Live Overlay (Firebase + SimBrief)</title>

<link rel="icon" type="image/png" sizes="32x32" href="logo192.png">
<link rel="apple-touch-icon" href="logo192.png">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1d1f22">
<meta name="apple-mobile-web-app-title" content="CrabbyFlight">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="description" content="CrabbyFlight — a lightweight live overlay tool for flight-sim streamers. Add webcam frames, info boards, and SimBrief-driven flight data for clean OBS overlays.">
  <meta property="og:description" content="CrabbyFlight — lightweight live overlay tool for flight-sim streamers. Add webcam frames, info boards, and SimBrief-driven flight data.">

<script>
  (function () {
    const raw = (location.hash || '').replace(/^#/, '');
    const mode = (raw.split(':')[0] || 'editor').toLowerCase();
    document.addEventListener('DOMContentLoaded', () => {
      document.body.classList.add(mode || 'editor');
      try{ const saved = localStorage.getItem('cf_theme'); if(saved==='dark') document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark'); }catch(e){}
      // Keep the toggle-in-editor in sync with the saved theme; this lets nested editors keep the right position
      try{ const themeHidden = document.getElementById('theme'); const themeToggle = document.getElementById('theme_toggle'); if(themeHidden && themeToggle){ themeToggle.checked = ((themeHidden.value||'dark') === 'dark'); } }catch(e){}
    });
    const standalone = matchMedia('(display-mode: standalone)').matches || navigator.standalone;
    if (standalone && (mode === 'info' || mode === 'departures' || mode === 'frame')) {
      document.documentElement.classList.add('show-splash');
    }
  })();
</script>

<style>
  :root{
    --bg:#f7fafc; --panel:#ffffff; --ink:#0f1724; --muted:#6b7280; --line:#e6e9ef;
    --brand:#1e90ff; --accent:#2563eb; --shadow:0 6px 18px rgba(14,30,37,.06);
    --radius:10px; --gap:12px;
  }
  /* Dark theme overrides */
  html.dark{ --bg:#0b1220; --panel:#0f1724; --ink:#e6eef6; --muted:#94a3b8; --line:#1f2a3b; --brand:#60a5fa; --accent:#3b82f6; --shadow:0 8px 22px rgba(2,6,23,.6); }
  /* Ensure general buttons remain legible in dark mode */
  html.dark button{ background:var(--panel); color:var(--ink); border:1px solid rgba(255,255,255,0.04); box-shadow:0 6px 18px rgba(0,0,0,.4); }
  html.dark .btns button{ background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-color:rgba(255,255,255,0.04) }
  html.dark button[disabled]{ opacity:0.6 }
  /* Slightly darker accent for primary to improve contrast in dark mode */
  html.dark button.primary{ background: #1f6fe8; box-shadow:0 4px 12px rgba(31,111,232,.14) }
  #screen-editor,#screen-info,#screen-departures,#screen-auth,#screen-frame{display:none}
  body.editor #screen-editor{display:block}
  body.info #screen-info{display:block}
  body.departures #screen-departures{display:block}
  body.frame #screen-frame{display:block}
  body.require-auth #screen-editor{display:none!important}
  body.require-auth #screen-auth{display:block}

  #inapp-splash{position:fixed;inset:0;z-index:9999;display:none;background:var(--bg);align-items:center;justify-content:center;flex-direction:column;transition:opacity .35s ease}
  .show-splash #inapp-splash{display:flex}
  #inapp-splash img{width:160px;height:160px;opacity:0;transform:scale(.95);animation:cfLogoPop .45s ease forwards .08s}
  #inapp-splash .label{margin-top:14px;color:var(--ink);font-weight:600;opacity:.7;letter-spacing:.2px}
  @keyframes cfLogoPop{to{opacity:1;transform:scale(1)}}
  body.ready #inapp-splash{opacity:0;pointer-events:none}

  html,body{margin:0;padding:0;height:100%;background:transparent!important;color:var(--ink);
    font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;text-rendering:optimizeLegibility}
  body.editor{background:var(--bg)!important}
  body.info,body.departures{background:transparent!important}

  /* Remove all text shadows from editor */
  .wrap,.card,label,input,select,button,h1,h2,h3,.footer{text-shadow:none!important}

  .wrap{max-width:1180px;margin:0 auto;padding:28px;background:var(--bg)}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:18px;margin:12px 0;box-shadow:var(--shadow)}
  h1{margin:0 0 18px;font-size:26px;font-weight:700;letter-spacing:.2px;color:var(--ink)}
  label{display:block;font-size:13px;font-weight:700;color:var(--muted);margin:8px 0 8px}
  input,select{width:100%;background:transparent;border:1px solid var(--line);color:var(--ink);border-radius:8px;padding:10px 12px;height:44px;box-sizing:border-box;outline:none;appearance:none;font-family:inherit}
  /* ensure checkboxes render normally instead of inheriting text input styles */
  input[type="checkbox"]{width:18px;height:18px;box-sizing:content-box;padding:0;margin:0 8px 0 0;background:transparent;border:1px solid var(--line);border-radius:4px;appearance:none;cursor:pointer;display:inline-block;vertical-align:middle}
  input[type="checkbox"]:checked{background:var(--brand);border-color:var(--brand)}
  .wc-frame img{display:block;pointer-events:none;width:100%;height:100%;object-fit:contain;border-radius:inherit}
  input:focus,select:focus{border-color:#5b9cff;box-shadow:0 0 0 3px rgba(91,156,255,.18)}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap)}
  .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:var(--gap)}
  .btns{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:14px}
  button{border:1px solid var(--line);background:var(--panel);color:var(--ink);padding:10px 14px;border-radius:8px;cursor:pointer;transition:filter .12s ease,transform .02s ease;font-family:inherit;font-size:14px;font-weight:500}
  button:hover{filter:brightness(.98)}
  button.primary{background:var(--brand);border-color:transparent;color:white}
  /* Make sure primary buttons stay legible in dark mode */
  html.dark button.primary{color:white}
  button.primary:hover{filter:brightness(.98)}
  button:active{transform:translateY(1px)}

  /* Footer links */
  #screen-editor .footer{margin:24px 0 12px;padding-top:12px;border-top:1px solid var(--line);color:var(--muted);font-size:11px;text-align:center;font-weight:500;letter-spacing:0.2px}
  .footer a{color:var(--muted);text-decoration:none;transition:color .15s ease}
  .footer a:hover{color:var(--ink)}
  .footer .sep{margin:0 8px;color:var(--line)}

  /* Theme toggle */
  .switch{position:relative;display:inline-block;width:52px;height:28px}
  .switch input{display:none}
  .switch .slider{position:absolute;cursor:pointer;background:var(--line);top:2px;left:2px;right:2px;bottom:2px;border-radius:999px;transition:all .18s ease}
  .switch .slider:before{content:"";position:absolute;height:22px;width:22px;left:3px;top:3px;border-radius:50%;background:var(--panel);box-shadow:0 2px 6px rgba(0,0,0,.18);transition:all .18s ease}
  .switch input:checked + .slider{background:var(--brand)}
  .switch input:checked + .slider:before{transform:translateX(24px);background:white}

  .hint{color:var(--muted);font-size:13px}
  .pill{display:inline-block;padding:4px 10px;font-size:12px;border-radius:999px;background:transparent;border:1px solid var(--line);color:var(--muted)}
  .ok{color:#0ea5a4} .warn{color:#f59e0b}

  .sb-row{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:end}
  .sb-row button{height:44px}

  #screen-auth .auth-wrap{max-width:420px;margin:64px auto;padding:0 16px}
  .auth-logo{display:flex;justify-content:center;margin:4px 0 14px}
  .auth-logo img{max-width:260px;max-height:120px;object-fit:contain;filter:drop-shadow(0 6px 24px rgba(0,0,0,.25))}
  .auth-status{font-size:12px;color:#ffb4b4;min-height:18px}
  .auth-actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px}

  .container{position:absolute;top:-6px;left:50%;transform:translateX(-50%);width:100%;display:flex;justify-content:center;pointer-events:none}
  .container .info-box{pointer-events:auto;z-index:20}
  .info-left{text-align:left;display:flex;flex-direction:column;gap:6px;min-width:160px}
  .info-center{text-align:center;display:flex;flex-direction:column;gap:6px;padding:0 14px;flex-shrink:0;white-space:nowrap}
  .info-right{text-align:right;display:flex;flex-direction:column;gap:6px;min-width:160px}
  .info-airport{font-size:18px;font-weight:700;color:#FFA500;letter-spacing:.3px;line-height:1.05;white-space:nowrap}
  .info-time{font-size:13px;color:rgba(255,255,255,.9);font-weight:600}
  .info-time strong{font-weight:700;margin-right:4px}
  .plane-icon{vertical-align:middle;margin:0 5px;transform:rotate(90deg);width:16px;height:16px}

  @keyframes pulse{0%{transform:scale(1);opacity:1}50%{transform:scale(1.4);opacity:.7}100%{transform:scale(1);opacity:1}}
  @keyframes flashText{0%,50%,100%{opacity:1}25%,75%{opacity:.6}}
  .live-indicator{display:inline-flex;align-items:center;gap:5px}
  .live-dot{width:10px;height:10px;background:red;border-radius:50%;display:inline-block;animation:pulse 1s infinite}
  .live-text{color:red;font-weight:700;animation:flashText 1s infinite}
  .dynamic{color:#FFA500;font-weight:700;text-shadow:2px 2px 4px rgba(0,0,0,.9)}

  /* Flight visualization */
  .flight-track{width:100%;height:38px;background:rgba(255,255,255,.04);border-radius:999px;display:flex;align-items:center;padding:6px 10px;gap:8px}
  /* compact flight-track that sits at top of info box */
  .flight-track{position:absolute;left:50%;transform:translateX(-50%);top:8px;width:calc(100% - 40px);height:16px;background:transparent;border-radius:999px;display:flex;align-items:center;padding:4px 8px}
    /* slightly lower so there's a small visual gap between airports and the track */
    .info-box{position:relative;background:rgba(33,36,41,0.95);border:1px solid rgba(255,255,255,0.02);border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,.12);color:#fff;padding:44px 14px 10px;display:grid;grid-template-columns:1fr auto 1fr;gap:12px;align-items:start;max-width:900px;width:min(94%,900px);backdrop-filter:blur(0);box-sizing:border-box}
    .flight-track{top:8px}
  .flight-track .bar{position:relative;flex:1;height:8px;background:transparent;border-radius:999px;overflow:hidden}
  .flight-track .bar .pos{position:absolute;left:0;top:0;bottom:0;width:0;background:linear-gradient(90deg,#FFA500,#FFD100);transition:width .25s linear;box-shadow:0 0 10px rgba(255,170,0,.12)}
  .flight-track .plane{position:absolute;top:50%;transform:translate(-50%,-50%);width:18px;height:18px;border-radius:50%;background:rgba(255,255,255,.98);display:flex;align-items:center;justify-content:center;box-shadow:0 6px 10px rgba(0,0,0,.25)}
  .flight-phase{font-weight:700;color:#fff}
  .flight-meta{font-size:12px;color:rgba(255,255,255,.85);margin-top:4px;display:flex;justify-content:space-between;gap:8px}
  .airport-weather{font-size:14px;font-weight:700;color:rgba(255,255,255,.9);margin-top:6px}

  .board{position:absolute;top:32px;left:32px;min-width:760px;border-radius:var(--frame-border-radius,12px);overflow:hidden;background:linear-gradient(180deg, rgba(44,48,54,.98), rgba(33,36,41,.98));border:1px solid var(--frame-border-color, #3d434b);box-shadow:0 14px 34px rgba(0,0,0,.22)}
  .header{background:var(--brand);color:white;display:flex;align-items:center;gap:10px;font-weight:700;letter-spacing:.3px;padding:12px 18px;font-size:20px;position:relative;overflow:hidden;border-bottom:1px solid rgba(255,255,255,.03)}
  .header svg{width:22px;height:22px}
  .header::after{content:"";position:absolute;top:0;left:-45%;width:40%;height:100%;background:linear-gradient(120deg, rgba(255,209,0,0) 0%, rgba(255,209,0,.45) 50%, rgba(255,209,0,0) 100%);filter:blur(1px);animation:hdrSweep 4s linear infinite;display:none}
  body.ready .header::after{display:block}
  @keyframes hdrSweep{0%{transform:translateX(0)}100%{transform:translateX(250%)}}
  .table{display:grid;grid-template-columns:96px 1fr 1fr 120px 72px 188px;column-gap:14px;padding:10px 18px 14px;font-size:17px;color:#fff}
  .th,.tr{display:contents}
  .th span{color:#cfcfcf;padding:8px 0 6px;border-bottom:1px solid rgba(255,255,255,.20);text-transform:uppercase;font-size:14px;letter-spacing:.8px}
  .cell{padding:10px 0;border-bottom:1px solid rgba(255,255,255,.08);min-height:44px;display:flex;align-items:center}
  .status{display:inline-flex;align-items:center;gap:8px;padding:4px 12px;border-radius:999px;font-weight:700;font-size:13px;letter-spacing:.3px;background:#31363d;border:1px solid #3f454d}
  .dot{width:8px;height:8px;border-radius:50%;background:#999}
  .on-time{color:#00ff90}.on-time .dot{background:#00ff90}
  .boarding{color:#4dd2ff}.boarding .dot{background:#4dd2ff}
  .delayed{color:#ffb84d}.delayed .dot{background:#ffb84d}
  .cancelled{color:#ff4d4d}.cancelled .dot{background:#ff4d4d}
  .sideways{color:#FFA500}.sideways .dot{background:#FFA500}
  .status.custom{color:#5b9cff}.status.custom .dot{background:#5b9cff}
  .tr.real{position:relative}
  .tr.real .cell{background:linear-gradient(90deg,rgba(255,165,0,.12),rgba(255,165,0,0))}
  .tr.real::before{content:"";position:absolute;left:-25%;top:0;height:100%;width:20%;background:linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,.12), rgba(255,255,255,0));filter:blur(2px);transform:skewX(-8deg);animation:rowSheen 6s linear infinite}
  @keyframes rowSheen{0%{transform:translateX(0) skewX(-8deg)}100%{transform:translateX(650%) skewX(-8deg)}}
  .real .flight{color:#FFA500;font-weight:800}
  .real .from,.real .to{color:#FFA500;font-weight:700}
  .muted{color:#cfcfcf}
  .board .footer{display:flex;justify-content:flex-end;gap:24px;padding:10px 18px 16px;color:#cfcfcf;font-size:16px;white-space:nowrap;text-shadow:2px 2px 4px rgba(0,0,0,.7)}
  .footer strong{color:#fff}

  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center}
  .modal.open{display:flex}
  .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.55)}
  .sheet{position:relative;background:var(--panel);border:1px solid var(--line);border-radius:16px;min-width:560px;max-width:92vw;padding:18px 18px 14px;box-shadow:var(--shadow)}
  .sheet h3{margin:0 0 8px;font-size:20px}
  .url-row{display:grid;grid-template-columns:84px 1fr auto;gap:10px;align-items:center;margin:10px 0}
  .url-row code{color:var(--muted);font-family:inherit;font-size:13px;font-weight:600}
  .url-row input{height:42px}
  .modal-actions{display:flex;justify-content:flex-end;margin-top:8px}

  #screen-frame{z-index:10}
  .frame-root{position:absolute;inset:0;width:1920px;height:1080px;pointer-events:none}
  .frame-svg{position:absolute;inset:0;pointer-events:none}
  .frame-logo{position:absolute;left:50%;transform:translateX(-50%);top:12px;display:flex;align-items:center;gap:10px;font-weight:800;padding:8px 12px;border-radius:999px;background:rgba(33,36,41,.7);border:1px solid rgba(61,67,75,.85);text-shadow:2px 2px 4px rgba(0,0,0,.9)}
  .frame-logo img{width:22px;height:22px}
  .embed{position:absolute;transform-origin:top left}
  .embed iframe{width:980px;height:360px;border:0;background:transparent;pointer-events:none}
  .wc-frame{position:absolute;box-sizing:border-box;border-radius:16px;outline:6px solid var(--brand);box-shadow:0 12px 36px rgba(0,0,0,.5), inset 0 0 0 2px rgba(0,0,0,.35)}
</style>
</head>
<body>

<div id="inapp-splash" aria-hidden="true">
  <img src="logo192.png" alt="CrabbyFlight">
  <div class="label">CrabbyFlight</div>
</div>

<!-- AUTH -->
<div id="screen-auth">
  <div class="auth-wrap">
    <div class="card" style="text-align:center">
      <div class="auth-logo">
        <img src="logo.png" alt="CrabbyFlight" onerror="this.onerror=null; this.src='logo192.png'">
      </div>
      <label for="auth_email">Email</label><input id="auth_email" type="email" inputmode="email" autocomplete="username" placeholder="you@example.com">
      <label for="auth_password">Password</label><input id="auth_password" type="password" autocomplete="current-password" placeholder="••••••••">
      <div class="auth-actions">
        <button id="btn_signin" class="primary" type="button">Sign in</button>
        <button id="btn_signup" type="button" title="Create an account for yourself">Sign up</button>
      </div>
      <div class="auth-status" id="auth_status" role="status" aria-live="polite"></div>
    </div>
    <div class="card">
      <span class="pill" id="net_badge">Status: checking…</span>
    </div>
  </div>
</div>

<!-- EDITOR -->
<div id="screen-editor" class="wrap">
  <h1>CrabbyFlight — Overlay Editor</h1>

  <!-- SimBrief Integration -->
  <div class="card">
    <div class="sb-row">
      <div>
        <label for="simbrief_id">SimBrief PilotID or Username</label>
        <input id="simbrief_id" placeholder="e.g. 123456 / myhandle">
      </div>
      <button id="btn_import_sb" class="primary" type="button" title="Fetch your latest OFP and fill the fields">Import from SimBrief</button>
      <button id="btn_import_test" type="button" title="Run a local sample OFP import">Run Sample Import</button>
      <span class="pill" id="sb_status">Ready</span>
    </div>
  </div>

  <div class="card">
    <div class="grid">
      <div><label for="from">From</label><input id="from" placeholder="Oslo (ENGM)"></div>
      <div><label for="to">To</label><input id="to" placeholder="Liverpool (EGGP)"></div>
    </div>
    <div class="grid">
      <div><label for="flight">Flight</label><input id="flight" placeholder="POR9392"></div>
    </div>
    <div class="grid">
      <div><label for="gate">Gate (Departures)</label><input id="gate" placeholder="B12"></div>
      <div>
        <label for="status">Status (Departures)</label>
        <select id="status">
          <option value="on-time">ON TIME</option>
          <option value="boarding">BOARDING</option>
          <option value="delayed">DELAYED</option>
          <option value="cancelled">CANCELLED</option>
          <option value="sideways">SIDEWAYS</option>
          <option value="custom">Custom…</option>
        </select>
      </div>
    </div>

    <div class="grid" id="customRow" style="display:none">
      <div><label for="status_custom">Custom status text</label><input id="status_custom" placeholder="e.g. DIVERTED TO EDI"></div>
      <div><label>&nbsp;</label><input disabled value="Shown on the board as blue badge"></div>
    </div>

    <div class="grid">
      <div><label for="dep_utc">Departure UTC</label><input id="dep_utc" placeholder="14:30 UTC"></div>
      <div><label for="arr_utc">Arrival UTC</label><input id="arr_utc" placeholder="16:30 UTC"></div>
    </div>
    <div class="grid-3">
      <div><label for="aircraft">Aircraft (Info)</label><input id="aircraft" placeholder="A320-251N"></div>
      <div><label for="airframe">Airframe (Reg)</label><input id="airframe" placeholder="G-WALI"></div>
      <div><label for="cruise">Cruise (Info)</label><input id="cruise" placeholder="35,000ft"></div>
    </div>
    <div class="grid">
      <div><label for="dep_metar">Departure METAR (from SimBrief)</label><input id="dep_metar" placeholder="EGGP 141450Z 24010KT 9999 SCT030 09/04 Q1013" /></div>
      <div><label for="arr_metar">Arrival METAR (from SimBrief)</label><input id="arr_metar" placeholder="EGPH 141550Z 26012KT 9999 BKN040 08/03 Q1011" /></div>
    </div>
    
    <div class="grid-3" style="margin-top:8px">
      <div>
        <label for="infoLive">Show live indicator</label>
        <div style="display:flex;align-items:center;gap:8px;margin-top:6px"><input id="infoLive" type="checkbox" checked><span class="hint">Show the LIVE indicator on the info overlay</span></div>
      </div>
      <div>
        <label for="infoRes">Show resolution</label>
        <div style="display:flex;align-items:center;gap:8px;margin-top:6px"><input id="infoRes" type="checkbox" checked><span class="hint">Display resolution text (e.g., 1080p60FPS)</span></div>
      </div>
      <div>
        <label for="infoPlatform">Show platform</label>
        <div style="display:flex;align-items:center;gap:8px;margin-top:6px"><input id="infoPlatform" type="checkbox" checked><span class="hint">Display platform text (macOS + OneCast)</span></div>
      </div>
    </div>
    <div class="grid-3" style="margin-top:8px">
      <div>
        <label for="infoResText">Resolution text</label>
        <input id="infoResText" placeholder="1080p60FPS">
      </div>
      <div>
        <label for="infoPlatformText">Platform text</label>
        <input id="infoPlatformText" placeholder="macOS + OneCast">
      </div>
      <div></div>
    </div>

    <div class="card" style="margin-top:10px">
      <h3 style="margin:0 0 10px;font-size:18px">Frame and Webcam Settings</h3>

      <div class="grid-3">
        <div>
          <label for="wcPreset">Webcam Size</label>
          <select id="wcPreset">
            <option value="1920x1080">1920×1080</option>
            <option value="1280x720">1280×720</option>
            <option value="960x540">960×540</option>
            <option value="640x480">640×480</option>
            <option value="352x288">352×288</option>
            <option value="320x240">320×240</option>
          </select>
        </div>
        <div><label for="wcX">Webcam X</label><input id="wcX" type="number" placeholder="32"></div>
        <div><label for="wcY">Webcam Y</label><input id="wcY" type="number" placeholder="700"></div>
      </div>

      <input id="wcW" type="hidden" value="1280">
      <input id="wcH" type="hidden" value="720">
      <input id="flightTakeoffEpoch" type="hidden" value="">
      <input id="flightLanded" type="hidden" value="off">

      <div class="grid-3">
        <div><label for="frameBorderColor">Frame Border Color</label><input id="frameBorderColor" type="color" value="#3d434b"></div>
        
        <div><label for="frameBorderRadius">Border Radius (Frame/Info/Webcam)</label><input id="frameBorderRadius" type="number" placeholder="28" value="28"></div> 
        <div>
          <label for="frameBorderWidth">Border Width (Frame/Webcam) (px)</label>
          <div style="display:flex;align-items:center;gap:8px;margin-top:6px">
            <input id="frameBorderWidth_range" type="range" min="0" max="48" value="6">
            <input id="frameBorderWidth" type="number" min="0" max="48" placeholder="6" style="width:64px">
          </div>
        </div>
        <div>
          <label for="wcShow">Toggle webcam</label>
          <div style="display:flex;align-items:center;gap:8px;margin-top:6px"><input id="wcShow" type="checkbox" checked><span class="hint">Toggle webcam on/off</span></div>
        </div>
      </div>
      <div class="grid">
        <div><label>Rounded mask (matches webcam size & radius)</label></div>
        <div><label>&nbsp;</label><button id="btn_download_mask" type="button">Download rounded mask PNG</button></div>
      </div>



      <div class="grid-3" style="margin-top:10px">
        <div>
          <label for="logoShow">Show frame logo</label>
          <div style="display:flex;align-items:center;gap:8px;margin-top:6px"><input id="logoShow" type="checkbox" checked><span class="hint">Show the CrabbyFlight logo on the frame</span></div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:10px">
      <h3 style="margin:0 0 10px;font-size:18px">Flight Visualization</h3>
      <div class="grid-3">
        <div>
          <label for="flightVizEnabled">Enable visualization</label>
          <div style="display:flex;align-items:center;gap:8px;margin-top:6px"><input id="flightVizEnabled" type="checkbox"><span class="hint">Show a live progress bar for the flight</span></div>
        </div>
        <!-- Removed 'Show on info overlay' checkbox: visualization is shown on the info overlay when enabled -->

      </div>
      <div style="display:flex;gap:8px;margin-top:12px;align-items:center">
        <button id="flightTakeoff" type="button">Takeoff</button>
        <button id="flightLanded" type="button">Landed</button>
      </div>
    </div>

    <div class="btns">
      <button id="openInfo" type="button">Open Info</button>
      <button id="openDep" type="button">Open Departures</button>
      <button id="openFrame" type="button">Open Frame</button>
      <button id="copyUrls" class="primary" type="button" title="Show your OBS overlay URLs">UID: <span id="uid_in_btn">—</span> • Show OBS URLs</button>
      <div style="display:flex;align-items:center;gap:8px;margin-left:auto">
        <input id="theme" type="hidden" value="dark">
        <label for="theme_toggle" style="margin:0;font-weight:700;color:var(--muted);font-size:13px">Theme</label>
        <label class="switch" title="Toggle dark mode">
          <input id="theme_toggle" type="checkbox" aria-label="Theme toggle">
          <span class="slider"></span>
        </label>
      </div>
      <button id="btn_signout" type="button" style="margin-left:8px">Sign out</button>
    </div>
    <div class="footer">
      <a href="about.html" target="_blank" rel="noopener">About</a>
      <span class="sep">|</span>
      <a href="README.md" target="_blank" rel="noopener">README</a>
      <span class="sep">|</span>
      <a href="license.txt" target="_blank" rel="noopener">License</a>
    </div>
  </div>
</div>

<!-- INFO OVERLAY -->
<div id="screen-info" class="container">
  <div class="info-box">
    <div class="info-left">
      <div class="info-airport" id="i_from">LIVERPOOL (EGGP)</div>
      <div class="info-time"><strong>Departs:</strong> <span class="dynamic" id="i_dep_utc">15:05 UTC</span></div>
    </div>

    <div class="info-center">
      <div style="font-size:18px;font-weight:700;margin-bottom:2px">
        <span style="color:rgba(255,255,255,.85)">Flight:</span> <span class="dynamic" id="i_flight">WAL113</span>
      </div>
      <div id="flightViz" style="width:100%;max-width:900px;display:none">
        <div class="flight-track" role="region" aria-label="Flight progress">
          <div class="bar" id="flightBar"><div class="pos" id="flightPos"></div></div>
          <div class="plane" id="flightPlane" aria-hidden="true">
            <svg viewBox="0 0 24 24" width="18" height="18" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path fill="#111" d="M21 16v-2l-8-5V3.5a.5.5 0 0 0-.5-.5h-1A.5.5 0 0 0 11 3.5V9l-8 5v2l8-1v4l2-.5v1l3-1-3 1v-1l2-.5v-4l8 1z"/></svg>
          </div>
        </div>
        <div class="flight-meta" id="flightMeta"><div id="flightFrom">—</div><div id="flightPhase" class="flight-phase" aria-live="polite">—</div><div id="flightTo">—</div></div>

      </div>
      <div style="font-size:15px;line-height:1.6">
        <div><strong>Aircraft:</strong> <span class="dynamic" id="i_aircraft">A320-251N (G-WALI)</span></div>
        <div><strong>Time:</strong> <span class="dynamic" id="i_enroute">~42m</span></div>
      </div>
      <div style="display:flex;align-items:center;justify-content:center;gap:12px;margin-top:6px;font-size:12px;opacity:.85">
        <span class="live-indicator" id="i_live_block"><span class="live-dot"></span><span class="live-text">LIVE</span></span>
        <span id="i_res">1080p60FPS</span> <span id="i_sep" class="sep">|</span> <span id="i_platform">macOS + OneCast</span>
      </div>
    </div>

    <div class="info-right">
      <div class="info-airport" id="i_to">EDINBURGH (EGPH)</div>
      <div class="info-time"><strong>Arrives:</strong> <span class="dynamic" id="i_arr_utc">16:10 UTC</span></div>
    </div>
  </div>
</div>

<!-- DEPARTURES OVERLAY -->
<div id="screen-departures" class="board" aria-live="polite">
  <div class="header">
    <svg viewBox="0 0 24 24" fill="black" aria-hidden="true"><path d="M2.5 19h19v2h-19zM3.87 9.91l4.12 1.28 4.75-4.89 1.88.59-2.91 6.83 7.23 2.25c.53.17.87.64.87 1.2 0 .82-.79 1.41-1.17 1.17L.69 12.38l.53-1.96 2.65-.51z"/></svg>
    DEPARTURES
  </div>

  <div class="table">
    <div class="th">
      <span>Time</span><span>From</span><span>To</span><span>Flight</span><span>Gate</span><span>Status</span>
    </div>

    <div class="tr">
      <div class="cell">13:55</div><div class="cell">Springfield (SPFD)</div><div class="cell">Shelbyville (SHBY)</div><div class="cell">SPF101</div><div class="cell">A07</div>
      <div class="cell"><span class="status on-time"><span class="dot"></span>ON TIME</span></div>
    </div>
    <div class="tr">
      <div class="cell">14:05</div><div class="cell">Gotham (GTHM)</div><div class="cell">Metropolis (MTRP)</div><div class="cell">BAT247</div><div class="cell">C03</div>
      <div class="cell"><span class="status delayed"><span class="dot"></span>DELAYED 12 MIN</span></div>
    </div>

    <div class="tr real">
      <div class="cell" id="d_time">14:30</div>
      <div class="cell from" id="d_from">Oslo (ENGM)</div>
      <div class="cell to" id="d_to">Liverpool (EGGP)</div>
      <div class="cell flight" id="d_flight">POR9392</div>
      <div class="cell gate" id="d_gate">B12</div>
      <div class="cell">
        <span class="status on-time" id="d_status"><span class="dot"></span><span id="d_status_text">ON TIME</span></span>
      </div>
    </div>

    <div class="tr">
      <div class="cell">15:10</div><div class="cell">Area 51 (????)</div><div class="cell">Roswell (RSWL)</div><div class="cell">UFO001</div><div class="cell">X99</div>
      <div class="cell"><span class="status boarding"><span class="dot"></span>BOARDING</span></div>
    </div>
    <div class="tr">
      <div class="cell">15:25</div><div class="cell">Atlantis (ATLS)</div><div class="cell">Bermuda (BRMD)</div><div class="cell">SEA404</div><div class="cell">D21</div>
      <div class="cell"><span class="status cancelled"><span class="dot"></span>CANCELLED</span></div>
    </div>
  </div>

  <div class="footer">
    <div><span class="muted">Time en route:</span> <strong id="d_enroute">~2 hrs</strong></div>
    <div><span class="muted">Departure:</span> <strong id="d_dep">14:30 UTC</strong></div>
    <div><span class="muted">Arrival:</span> <strong id="d_arr">16:30 UTC</strong></div>
  </div>
</div>

<!-- FRAME OVERLAY -->
<div id="screen-frame" class="frame-root" aria-hidden="false">
  <svg class="frame-svg" viewBox="0 0 1920 1080" preserveAspectRatio="none">
    <defs>
      <mask id="matteMask">
        <rect x="0" y="0" width="1920" height="1080" fill="white"/>
        <rect id="hole" x="16" y="38" width="1888" height="1026" rx="28" ry="28" fill="black"/>
      </mask>
      <linearGradient id="g" x1="0" y1="0" x2="1" y2="0">
        <stop offset="0" stop-color="#FFD100"/><stop offset=".5" stop-color="#FFA500"/><stop offset="1" stop-color="#FFD100"/>
      </linearGradient>
    </defs>
    <rect id="matteRect" x="0" y="0" width="1920" height="1080" fill="#1d1f22" mask="url(#matteMask)"/>
    <rect id="borderRect" x="16" y="38" width="1888" height="1026" rx="28" ry="28" fill="none" stroke="url(#g)" stroke-width="8"/>
    <rect id="borderOutline" x="16" y="38" width="1888" height="1026" rx="28" ry="28" fill="none" stroke="rgba(0,0,0,.6)" stroke-width="1"/>
    <rect id="hairRect"   x="26" y="48" width="1868" height="1006" rx="22" ry="22" fill="none" stroke="rgba(0,0,0,.6)" stroke-width="2"/>
  </svg>

  <div class="frame-logo" id="frame_logo">
    <img src="logo192.png" alt="CrabbyFlight"><span>CrabbyFlight</span>
  </div>

  <div id="wc" class="wc-frame" style="left:32px;top:700px;width:420px;height:236px">
    <img id="wc_afk" src="afklogo.png" alt="AFK logo">
  </div>

  <div id="embed_info" class="embed info" style="display:none" aria-hidden="true">
    <iframe id="info_iframe" src="" allowtransparency="true" title="Info overlay"></iframe>
  </div>
</div>

<!-- URLs Modal -->
<div id="url_modal" class="modal" aria-hidden="true">
  <div class="backdrop" id="url_modal_bg"></div>
  <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="url_title">
    <h3 id="url_title">Your OBS overlay URLs</h3>
    <div class="url-row">
      <code>Info</code>
      <input id="url_info" readonly>
      <button id="copy_info" type="button">Copy</button>
    </div>
    <div class="url-row">
      <code>Departures</code>
      <input id="url_dep" readonly>
      <button id="copy_dep" type="button">Copy</button>
    </div>
    <div class="url-row">
      <code>Frame</code>
      <input id="url_frame" readonly>
      <button id="copy_frame" type="button">Copy</button>
    </div>
    <div class="modal-actions">
      <button id="close_modal" type="button">Close</button>
    </div>
    <div class="hint">Tip: you can add <code>?x</code>, <code>?y</code>, <code>?scale</code> to these in OBS.</div>
  </div>
</div>

<script type="module">
  (function cleanupLegacyFrame(){
    try{
      document.querySelectorAll('#frame-toggle, #frame-banner').forEach(n=>n.remove());
      const frames = document.querySelectorAll('#screen-frame');
      if (frames.length > 1){ frames.forEach((n,i)=>{ if(i>0) n.remove(); }); }
    }catch(e){}
  })();

  const firebaseConfig = {
    apiKey: "AIzaSyBs4FN-KgUH7cQl15BFyCSLGGq-O-Ey4u0",
    authDomain: "crabbyflight.firebaseapp.com",
    databaseURL: "https://crabbyflight-default-rtdb.firebaseio.com",
    projectId: "crabbyflight",
    storageBucket: "crabbyflight.firebasestorage.app",
    messagingSenderId: "741648861487",
    appId: "1:741648861487:web:583ec0887f5ac3dce079da",
    measurementId: "G-8PZNG3Y1CE"
  };
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);
  const auth = getAuth(app);

  if (!location.hash) location.replace('#editor:crabroom');
  function parseHash(){
    const raw = (location.hash||'').replace(/^#/, '');
    const [mode, room] = raw.split(':');
    return { mode: (mode||'editor').toLowerCase(), room: room||'crabroom' };
  }
  let { mode, room } = parseHash();
  try { if (room) localStorage.setItem('lastRoom', room); } catch {}
  function applyMode(){
    document.body.classList.remove('editor','info','departures','frame');
    document.body.classList.add(mode);
  }
  applyMode();

  let dbUnsub = null;
  let firstPaint = false;
  let editorBound = false;
  let signedInUser = null;
  let canSave = false;

  addEventListener('hashchange', ()=>{
    ({mode, room}=parseHash());
    document.body.classList.remove('ready','require-auth');
    firstPaint = false;
    canSave = false;
    applyMode();
    bind();
  });

  const FIELDS = ["simbrief_id","from","to","flight","gate","status","status_custom","dep_utc","arr_utc","aircraft","airframe","cruise","dep_metar","arr_metar","frameBorderColor","frameBorderRadius",
    "wcPreset","wcX","wcY","wcW","wcH","frameBorderWidth","wcShow","logoShow","infoLive","infoRes","infoPlatform","infoResText","infoPlatformText","theme",
    "flightVizEnabled","flightTakeoffEpoch","flightLanded"];
  const DEFAULTS = { simbrief_id:"", from:"Oslo (ENGM)", to:"Liverpool (EGGP)", flight:"POR9392", gate:"B12",
    status:"on-time", status_custom:"", dep_utc:"14:30 UTC", arr_utc:"16:30 UTC",
    aircraft:"A320-251N", airframe:"", cruise:"35,000ft", dep_metar:'', arr_metar:'', frameBorderColor: "#3d434b", frameBorderRadius: "28",
    wcPreset:"1280x720", wcX:"32", wcY:"700", wcW:"1280", wcH:"720", frameBorderWidth:"6", wcShow:"on",
    theme: "dark",
    logoShow:"on", infoLive:"on", infoRes:"on", infoPlatform:"on", infoResText:"1080p60FPS", infoPlatformText:"macOS + OneCast",
    flightVizEnabled: "off", flightTakeoffEpoch: "", flightLanded: "off" };

  /* ---------- Time helpers ---------- */
  function normalizeHM(h, m){
    if(!Number.isFinite(h)||!Number.isFinite(m)) return null;
    if(m>=60){ h+=Math.floor(m/60); m%=60; }
    h=((h%24)+24)%24;
    return {h,m};
  }
  function parseHHMM(s){
    if(!s) return null;
    const str=String(s).trim();
    let m=str.match(/(\d{2}):(\d{2})/);
    if(!m){
      const digits=str.replace(/\D+/g,'');
      if(digits.length>=4) m=[null,digits.slice(-4,-2),digits.slice(-2)];
    }
    if(!m) return null;
    return {h:parseInt(m[1],10), m:parseInt(m[2],10)};
  }
  function hmToLabel(h,m){
    const nm=normalizeHM(h,m); if(!nm) return '';
    return `${String(nm.h).padStart(2,'0')}:${String(nm.m).padStart(2,'0')} UTC`;
  }
  function parseTimeUTC(any){ const hm=parseHHMM(any); return hm? hmToLabel(hm.h, hm.m) : ''; }
  function parseOffsetToMinutes(off){
    if(!off) return null;
    const raw=String(off).trim();
    // quick path for canonical ISO offsets and 'Z'
    const s = raw.toUpperCase();
    if(s==='Z') return 0;
    // try variants: +HH:MM, +HHMM, +HH, -HH, +H
    // strip common leading tokens like 'GMT' or 'UTC'
    let cleaned = raw.replace(/^(?:GMT|UTC)\s*/i, '').trim();
    // also strip surrounding parentheses
    cleaned = cleaned.replace(/[()]/g,'').trim();
    // Now try common numeric forms
    const m1 = cleaned.match(/^([+-]?)(\d{1,2}):?(\d{2})$/);
    if(m1){ const sign=m1[1]==='-'?-1:1; return sign*(parseInt(m1[2],10)*60+parseInt(m1[3],10)); }
    // forms like '+3' or '-3' or '3'
    const m2 = cleaned.match(/^([+-]?)(\d{1,2})$/);
    if(m2){ const sign=m2[1]==='-'?-1:1; const hrs=parseInt(m2[2],10); return sign*(hrs*60); }
    // decimal hours like '+4.5'
    const m3 = cleaned.match(/^([+-]?)(\d{1,2})\.(\d+)$/);
    if(m3){ const sign=m3[1]==='-'?-1:1; const hrs=parseInt(m3[2],10); const mins = Math.round(parseFloat('0.'+(m3[3]||'0'))*60); return sign*(hrs*60+mins); }
    // fallback for 3-4 digit numeric like 0100 or 530
    const m4 = cleaned.match(/^([+-]?)(\d{3,4})$/);
    if(m4){ const sign=m4[1]==='-'?-1:1; const num=parseInt(m4[2],10); const hrs=Math.floor(num/100), mins=num%100; return sign*(hrs*60+mins); }
    return null;
  }

  function addMinutesHM(h,m,delta){
    const total=h*60+m+delta;
    const t=((total%(24*60))+(24*60))%(24*60);
    return {h:Math.floor(t/60), m:t%60};
  }

  function formatEte(val){
    const raw=(val||'').toString().trim();
    if(!raw) return '';
    let m=raw.match(/^(\d{1,2}):(\d{2})$/);
    if(m){ const hm=normalizeHM(parseInt(m[1],10), parseInt(m[2],10)); return `~${hm.h}h${hm.m?` ${hm.m}m`:''}`; }
    if(/^[0-9]+$/.test(raw)){
      const num=parseInt(raw,10);
      if(raw.length===4 && num<=2359){ const hm=normalizeHM(Math.floor(num/100), num%100); return `~${hm.h}h${hm.m?` ${hm.m}m`:''}`; }
      const mins = num>600 ? Math.round(num/60) : num;
      const h=Math.floor(mins/60), mm=mins%60;
      return h?`~${h}h${mm?` ${mm}m`:''}`:`~${mm}m`;
    }
    return raw;
  }
  function sanitizeUTCField(el){
    if(!el) return;
    const fixed=parseTimeUTC(el.value);
    if(fixed){ const changed=el.value!==fixed; el.value=fixed; if(changed) el.dispatchEvent(new Event('input')); }
  }

  /* ---------- SimBrief parsing ---------- */
  const pickText = (doc, ...qs)=>{
    for(const q of qs.flat()){
      const n=doc.querySelector(q);
      const t=n?.textContent?.trim();
      if(t) return t;
    }
    return '';
  };

  function getUtcTime(doc, kind){
    const utcSelectors = kind==='dep'
      ? ['times sched_out_zulu','times sched_out_utc','general dep_time_utc','general dep_time_zulu']
      : ['times sched_in_zulu','times sched_in_utc','general arr_time_utc','general arr_time_zulu'];

    const localSelectors = kind==='dep'
      ? ['times sched_out','general dep_time']
      : ['times sched_in','general arr_time'];

    const offSelectors = kind==='dep'
      ? ['origin utc_offset','origin gmt_offset','origin tz_offset','general orig_utc_offset','general orig_timezone']
      : ['destination utc_offset','destination gmt_offset','destination tz_offset','general dest_utc_offset','general dest_timezone'];

    const utcRaw = pickText(doc, utcSelectors);
    if(utcRaw){
      // If a numeric epoch is returned in a UTC selector, convert that
      const epochMatch = String(utcRaw).trim().match(/^\d{9,}$/);
      if(epochMatch){
        const d = new Date(parseInt(utcRaw,10)*1000);
        const label = `${String(d.getUTCHours()).padStart(2,'0')}:${String(d.getUTCMinutes()).padStart(2,'0')} UTC`;
        return { label, source: utcSelectors.find(s=>doc.querySelector(s)) || 'utc', raw: { utcRaw, localRaw: '', offRaw: '' } };
      }
      const label = parseTimeUTC(utcRaw);
      return { label, source: utcSelectors.find(s=>doc.querySelector(s)) || 'utc', raw: { utcRaw, localRaw: '', offRaw: '' } };
    }

    const localRaw = pickText(doc, localSelectors);
    let offRaw   = pickText(doc, offSelectors);
    // Some sources embed offset inside the local time string (e.g. "15:05 UTC+1" or "15:05 +01:00")
    if(!offRaw && localRaw){
      const ext = (localRaw.match(/([+-]\d{1,2}:?\d{2})/) || localRaw.match(/UTC([+-]\d{1,2}:?\d{2})/i) || localRaw.match(/GMT([+-]\d{1,2}:?\d{2})/i));
      if(ext) offRaw = ext[0].replace(/^UTC/i,'').replace(/^GMT/i,'');
    }
    if(localRaw){
      // If localRaw looks like a Unix epoch timestamp, convert directly to UTC label
      const epochMatch = localRaw.trim().match(/^\d{9,}$/);
      if(epochMatch){
        const d = new Date(parseInt(localRaw,10)*1000);
        const label = `${String(d.getUTCHours()).padStart(2,'0')}:${String(d.getUTCMinutes()).padStart(2,'0')} UTC`;
        return { label, source: 'utc(epoch)', raw: { utcRaw:'', localRaw, offRaw:'' } };
      }
      const hm = parseHHMM(localRaw);
      if(hm){
        const offMin = parseOffsetToMinutes(offRaw);
        if(offMin!==null){
          const utcHM = addMinutesHM(hm.h, hm.m, -offMin); // local -> UTC
          return { label: hmToLabel(utcHM.h, utcHM.m), source: (offRaw?`local+offset(${offRaw})`:'local'), raw: { utcRaw:'', localRaw, offRaw }, hm, offMin };
        }
        return { label: hmToLabel(hm.h, hm.m), source: 'local(no offset)', raw: { utcRaw:'', localRaw, offRaw }, hm, offMin: null };
      }
    }
    const any = pickText(doc, [...utcSelectors, ...localSelectors]);
    return { label: parseTimeUTC(any), source: 'fallback', raw: { utcRaw: any, localRaw: '', offRaw: '' } };
  }

  async function importFromSimBrief(pilotOrUser){
    const urls = [
      `https://www.simbrief.com/api/xml.fetcher.php?userid=${encodeURIComponent(pilotOrUser)}`,
      `https://www.simbrief.com/api/xml.fetcher.php?username=${encodeURIComponent(pilotOrUser)}`
    ];
    let xmlText=null, lastErr=null;
    for(const u of urls){
      try{
        const res=await fetch(u,{cache:'no-store'});
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const t=await res.text();
        if(t && !/^\s*<\/?html/i.test(t)){ xmlText=t; break; }
      }catch(e){ lastErr=e; }
    }
    if(!xmlText) throw lastErr||new Error('No XML');

    const doc=new DOMParser().parseFromString(xmlText,'application/xml');
    if(doc.querySelector('parsererror')) throw new Error('XML parse error');

    return parseSimBriefDoc(doc);
  }

  // Extract useful fields from a parsed SimBrief XML document
  function parseSimBriefDoc(doc){
    const fromIcao = pickText(doc,'OFP origin icao_code','origin icao_code','general orig_icao');
    const fromName = pickText(doc,'OFP origin name','origin name','general orig_name','origin city');
    const toIcao   = pickText(doc,'OFP destination icao_code','destination icao_code','general dest_icao');
    const toName   = pickText(doc,'OFP destination name','destination name','general dest_name','destination city');

    const airline  = pickText(doc,'OFP general airline_icao','general airline_icao','general icao_airline');
    const fltNum   = pickText(doc,'OFP general flight_number','general flight_number','general number');
    const aircraft = pickText(doc,'OFP aircraft name','aircraft name','aircraft type','OFP aircraft icao_code','aircraft icao_code','general aircraft_icao');
    const airframe = pickText(doc,'aircraft reg','reg','OFP aircraft reg','general reg');
    const cruiseFt = pickText(doc,'OFP performance cruise_altitude','performance cruise_altitude','general cruise_altitude','general initial_altitude');
    const eteRaw   = pickText(doc,'OFP times est_time_enroute','times est_time_enroute','general ete');

    const fmtCruise=(a)=>{ const n=parseInt(String(a||'').replace(/\D/g,''),10); return Number.isFinite(n)&&n>0? n.toLocaleString()+'ft' : (a||''); };
    const fmtLoc=(name,icao)=> (name||icao) ? (name||icao)+(icao?` (${icao.toUpperCase()})`:'') : '';

    const dep = getUtcTime(doc, 'dep');
    const arr = getUtcTime(doc, 'arr');
    const depMetar = pickText(doc, 'origin metar','origin weather','OFP origin metar','OFP origin weather');
    const arrMetar = pickText(doc, 'destination metar','destination weather','OFP destination metar','OFP destination weather');

    return {
      patch: {
        from: fmtLoc(fromName, fromIcao),
        to:   fmtLoc(toName, toIcao),
        flight: (airline&&fltNum)?(airline.toUpperCase()+fltNum):pickText(doc,'general flight'),
        aircraft: (aircraft||'').toString().trim(),
        airframe: (airframe||'').toUpperCase(),
        cruise: fmtCruise(cruiseFt),
        enroute: formatEte(eteRaw),
        dep_utc: (dep?.label||'').toString().trim(),
        arr_utc: (arr?.label||'').toString().trim(),
        dep_metar: depMetar || '',
        arr_metar: arrMetar || ''
      },
      meta: { note: (dep?.label || arr?.label) ? 'utc_autosynced' : 'utc_unchanged', dep_src: dep?.source, arr_src: arr?.source }
    };
  }

  /* ---------- Editor binding ---------- */
  function bindEditor(){
    if (editorBound) return;
    editorBound = true;

    const editorEls = Object.fromEntries(FIELDS.map(id=>[id, document.getElementById(id)]));
    const statusEl = editorEls['status'];
    const customRow = document.getElementById('customRow');

    const setSimBriefStatus = (msg, warn=false, ok=false)=>{
      const b=document.getElementById('sb_status'); if(!b) return;
      b.textContent=msg||''; b.className='pill '+(warn?'warn':ok?'ok':'');
    };

    function read(){
      const d={};
      for(const k of FIELDS){
        const el = editorEls[k];
        if(!el){ d[k] = ''; continue; }
        if(el.type === 'checkbox') d[k] = el.checked ? 'on' : 'off';
        else d[k] = (el.value||'').toString().trim();
      }
      return d;
    }

    let t=null;
    function save(){
      if (!signedInUser || !canSave) return;
      clearTimeout(t);
      t=setTimeout(()=>set(ref(db, `rooms/${room}`), read()).catch(err=>setStatus(`Save failed: ${err.message}`)), 180);
    }
    for(const k of FIELDS){ const el=editorEls[k]; if(!el) continue; el.addEventListener('input', save); el.addEventListener('change', save); }

    ['dep_utc','arr_utc'].forEach(id=>{
      const el = editorEls[id]; if(!el) return;
      const onBlur = ()=> sanitizeUTCField(el);
      el.addEventListener('blur', onBlur);
      el.addEventListener('change', onBlur);
      sanitizeUTCField(el);
    });

    function toggleCustom(){ if(customRow) customRow.style.display = (statusEl?.value==='custom') ? 'grid' : 'none'; }
    if (statusEl){ statusEl.addEventListener('change', toggleCustom); toggleCustom(); }

    (function initWcPreset(){
      const preset = document.getElementById('wcPreset');
      const w = editorEls['wcW'], h = editorEls['wcH'];
      if (!preset || !w || !h) return;
      const MAP = {"1920x1080":[1920,1080],"1280x720":[1280,720],"960x540":[960,540],"640x480":[640,480],"352x288":[352,288],"320x240":[320,240]};
      function setWH(pVal){ const pair = MAP[pVal]; if (!pair) return; const [pw,ph]=pair; w.value=pw; h.value=ph; w.dispatchEvent(new Event('input')); h.dispatchEvent(new Event('input')); }
      preset.addEventListener('change', ()=>{ editorEls['wcPreset'].value = preset.value; setWH(preset.value); });
    })();

    function updatePreview(){
      const wc=document.getElementById('wc'); if(!wc) return;
      const toNum=(k, def)=>{ const el = editorEls[k]; const n = parseFloat(el?.value||''); return Number.isNaN(n)?def:n; };
      const wcX=toNum('wcX',32), wcY=toNum('wcY',700), wcW=toNum('wcW',1280), wcH=toNum('wcH',720);
      const curTheme = (editorEls['theme']?.value || DEFAULTS.theme || 'dark');
      try{ if(curTheme==='dark') document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark'); localStorage.setItem('cf_theme', curTheme); }catch(e){}
      const frameCol=(editorEls['frameBorderColor']?.value||'#3d434b');
      const bCol = frameCol;
      const bTh=toNum('frameBorderWidth',6);
      const frameRadius = toNum('frameBorderRadius',28);
      const wcRadius = frameRadius;
      const wcShown=(editorEls['wcShow']?.checked===true);
      const afkPath='afklogo.png';
      const pad = 16;
      wc.style.left=(wcX+pad)+'px'; wc.style.top=wcY+'px'; wc.style.width=wcW+'px'; wc.style.height=wcH+'px'; wc.style.display='block'; wc.style.borderRadius=`${frameRadius}px`;
      wc.style.outline = wcShown ? `${bTh}px solid ${bCol}` : 'none';
      wc.style.boxShadow = wcShown ? '0 0 0 1px rgba(0,0,0,.6), 0 12px 36px rgba(0,0,0,.5), inset 0 0 0 2px rgba(0,0,0,.35)' : 'none';
      const afkImg=document.getElementById('wc_afk');
      // Apply frame border color via CSS variable and preview svg border
      try{ document.documentElement.style.setProperty('--frame-border-color', frameCol); document.documentElement.style.setProperty('--frame-border-radius', `${frameRadius}px`); }catch(e){}
      const previewBorderRect=document.getElementById('borderRect'); if(previewBorderRect){ previewBorderRect.setAttribute('stroke', frameCol); previewBorderRect.setAttribute('stroke-width', bTh); previewBorderRect.setAttribute('rx', frameRadius); previewBorderRect.setAttribute('ry', frameRadius); }
      const previewHole=document.getElementById('hole'); if(previewHole){ previewHole.setAttribute('rx', frameRadius); previewHole.setAttribute('ry', frameRadius); }
      const previewBorderOutline=document.getElementById('borderOutline'); if(previewBorderOutline){ previewBorderOutline.setAttribute('stroke', 'rgba(0,0,0,.6)'); previewBorderOutline.setAttribute('stroke-width', '1'); previewBorderOutline.setAttribute('rx', frameRadius); previewBorderOutline.setAttribute('ry', frameRadius); }
      const previewHair=document.getElementById('hairRect'); if(previewHair){ previewHair.setAttribute('rx', frameRadius); previewHair.setAttribute('ry', frameRadius); previewHair.setAttribute('stroke', 'rgba(0,0,0,.6)'); }
      const frameLogoEl = document.getElementById('frame_logo');
      const logoShown = (editorEls['logoShow']?.checked === true);
      if(frameLogoEl){ frameLogoEl.style.display = logoShown ? 'flex' : 'none'; }
      // Info overlay bottom items preview
      const liveEl = document.getElementById('i_live_block');
      const resEl = document.getElementById('i_res');
      const platEl = document.getElementById('i_platform');
      const sepEl = document.getElementById('i_sep');
      const infoLiveShown = (editorEls['infoLive']?.checked === true);
      const infoResShown = (editorEls['infoRes']?.checked === true);
      const infoPlatformShown = (editorEls['infoPlatform']?.checked === true);
      const resText = (editorEls['infoResText']?.value || '1080p60FPS').toString().trim();
      const platText = (editorEls['infoPlatformText']?.value || 'macOS + OneCast').toString().trim();
      if(liveEl) liveEl.style.display = infoLiveShown ? 'inline-flex' : 'none';
      if(resEl){ resEl.textContent = resText; resEl.style.display = infoResShown ? 'inline' : 'none'; }
      if(platEl){ platEl.textContent = platText; platEl.style.display = infoPlatformShown ? 'inline' : 'none'; }
      if(sepEl) sepEl.style.display = (infoResShown && infoPlatformShown) ? 'inline' : 'none';
      if(afkImg){
        if(wcShown && afkPath){
          try{ const base = location.href.split('#')[0].split('?')[0]; afkImg.src = /^[a-zA-Z]+:/.test(afkPath) ? afkPath : new URL(afkPath, base).href; }catch(e){ afkImg.src = afkPath; }
          afkImg.style.display = 'block';
        } else {
          afkImg.style.display = 'none';
        }
      }
      // Render an editor preview of flight viz
      try{
        const previewD = {
          from: editorEls['from']?.value || DEFAULTS.from,
          to: editorEls['to']?.value || DEFAULTS.to,
          dep_utc: editorEls['dep_utc']?.value || DEFAULTS.dep_utc,
          arr_utc: editorEls['arr_utc']?.value || DEFAULTS.arr_utc,
          aircraft: editorEls['aircraft']?.value || DEFAULTS.aircraft,
          cruise: editorEls['cruise']?.value || DEFAULTS.cruise,
          dep_metar: editorEls['dep_metar']?.value || '',
          arr_metar: editorEls['arr_metar']?.value || '',
          flightVizEnabled: (editorEls['flightVizEnabled']?.checked ? 'on' : 'off'),
          flightTakeoffEpoch: editorEls['flightTakeoffEpoch']?.value || '',
          flightLanded: editorEls['flightLanded']?.value || 'off'
        };
        // Update small in-editor previews of the flight and info/frame overlays
        renderFlightViz(previewD);
        try{ renderInfo(previewD); }catch(e){}
        try{ renderFrame(previewD); }catch(e){}
      }catch(e){}
    }

    [ 'wcX','wcY','wcW','wcH','frameBorderWidth','wcShow','frameBorderColor','frameBorderRadius','logoShow','infoLive','infoRes','infoPlatform','infoResText','infoPlatformText', 'theme','flightVizEnabled','dep_metar','arr_metar' ].forEach(k=>{ const el=editorEls[k]; if(!el) return; el.addEventListener('input', updatePreview); el.addEventListener('change', updatePreview); });
    setTimeout(updatePreview, 80);

    // 'Show on info overlay' option removed; visualization is shown on the info overlay when enabled

    // Frame border width slider sync
    try{
      const rangeEl = document.getElementById('frameBorderWidth_range');
      const numEl = document.getElementById('frameBorderWidth');
      if(rangeEl && numEl){
        // initialize the UI value from persisted/hidden numeric field
        const initial = parseInt(numEl.value || '6', 10) || 6;
        rangeEl.value = initial;
        numEl.value = initial;
        rangeEl.addEventListener('input', ()=>{ const v = rangeEl.value; numEl.value = v; updatePreview(); save(); });
        numEl.addEventListener('input', ()=>{ const v = numEl.value; const n = Math.max(0, Math.min(48, parseInt(v||'0',10)||0)); rangeEl.value = n; updatePreview(); save(); });
        numEl.addEventListener('change', ()=>{ const v = numEl.value; const n = Math.max(0, Math.min(48, parseInt(v||'0',10)||0)); rangeEl.value = n; updatePreview(); save(); });
      }
    }catch(e){}
    // Theme toggle wiring
    try{
      const themeHidden = document.getElementById('theme');
      const themeToggle = document.getElementById('theme_toggle');
      if(themeHidden && themeToggle){
        // initialize based on the hidden value
        const v = (themeHidden.value||DEFAULTS.theme||'dark');
        themeToggle.checked = (v === 'dark');
        themeToggle.addEventListener('change', ()=>{
          const themeVal = themeToggle.checked ? 'dark' : 'light';
          themeHidden.value = themeVal; save(); updatePreview();
        });
      }
    }catch(e){}

    const byId = (id)=>document.getElementById(id);
    const openInNew = (url)=>{
      const w = window.open(url, '_blank');
      try{ if(w) w.opener = null; }catch(e){}
    };
    const bindIf = (id, fn)=>{ const el=byId(id); if(el) el.addEventListener('click', fn); };

    bindIf('openInfo',  ()=> openInNew(computeUrls().info));
    bindIf('openDep',   ()=> openInNew(computeUrls().dep));
    bindIf('openFrame', ()=> openInNew(computeUrls().frame));
    bindIf('copyUrls',  ()=> openUrlModal());
    bindIf('btn_signout', ()=> signOut(auth).catch(e=>setStatus(e.message)));
    bindIf('btn_download_mask', ()=>{
      const wcW=parseInt((editorEls['wcW']?.value||'1280'),10)||1280; const wcH=parseInt((editorEls['wcH']?.value||'720'),10)||720; const frameRadius=parseFloat((editorEls['frameBorderRadius']?.value||'28'))||28;
      let w=wcW, h=wcH; // canvas size
      // limit large sizes to avoid heavy images (scale down uniformly)
      const MAX_DIM=2048; let scale = 1; if(w>MAX_DIM || h>MAX_DIM){ scale = Math.min(MAX_DIM/w, MAX_DIM/h); w=Math.round(w*scale); h=Math.round(h*scale); }
      const c=document.createElement('canvas'); c.width=w; c.height=h;
      const ctx=c.getContext('2d');
      // OBS masks: white = visible, black = transparent. Fill black, then draw white rounded rect for webcam area
      ctx.fillStyle='black'; ctx.fillRect(0,0,w,h);
      ctx.fillStyle='white';
      const pad=0; const rr=Math.round(frameRadius*scale);
      const rx=pad, ry=pad, rw=w-pad*2, rh=h-pad*2;
      ctx.beginPath();
      ctx.moveTo(rx+rr, ry);
      ctx.arcTo(rx+rw, ry, rx+rw, ry+rh, rr);
      ctx.arcTo(rx+rw, ry+rh, rx, ry+rh, rr);
      ctx.arcTo(rx, ry+rh, rx, ry, rr);
      ctx.arcTo(rx, ry, rx+rw, ry, rr);
      ctx.closePath(); ctx.fill();
      const a=document.createElement('a'); a.href=c.toDataURL('image/png'); a.download=`crabbyflight-rounded-mask-${wcW}x${wcH}.png`; a.click();
    });

    bindIf('btn_import_sb', async ()=>{
      const id = (editorEls['simbrief_id']?.value||'').trim();
      if (!id){ setSimBriefStatus('Enter your PilotID or username', true); return; }
      try{
        setSimBriefStatus('Fetching…');
        const {patch, meta} = await importFromSimBrief(id);
        // SimBrief import meta available if needed for debugging

        // Apply imported values into editor fields (set even empty strings to clear)
        Object.entries(patch).forEach(([k,val])=>{
          const el = editorEls[k];
          if (el) el.value = (typeof val === 'undefined' ? '' : val);
        });

        // Normalize times before triggering preview updates
        sanitizeUTCField(editorEls['dep_utc']);
        sanitizeUTCField(editorEls['arr_utc']);

        // Always trigger input events so the editor preview (and frame fallback) updates immediately
        ['dep_utc','arr_utc','from','to','flight','aircraft','airframe','cruise','dep_metar','arr_metar']
          .forEach(k => editorEls[k]?.dispatchEvent(new Event('input')));

        // If signed in, save/publish the imported data
        if (canSave) save();

        if (meta?.note === 'utc_autosynced'){
          const depMsg = meta?.dep_src ? `DEP(${meta.dep_src})` : '';
          const arrMsg = meta?.arr_src ? `ARR(${meta.arr_src})` : '';
          setSimBriefStatus(`Imported ✓ (UTC updated ${depMsg} ${arrMsg})` + (canSave ? '' : ' — sign in to publish'), false, true);
        } else {
          setSimBriefStatus('Imported ✓ (UTC unchanged — manual)' + (canSave ? '' : ' — sign in to publish'), false, true);
        }
      }catch(err){
        setSimBriefStatus(`Import failed: ${err?.message||err}`, true);
      }
    });

    bindIf('btn_import_test', async ()=>{
      try{
        setSimBriefStatus('Running sample import…');
        const sampleXml = `<?xml version="1.0" encoding="UTF-8"?>
          <OFP>
            <origin>
              <icao_code>RJAA</icao_code>
              <name>Narita</name>
              <metar>RJAA 141200Z 22005KT 9999 SCT020 10/08 Q1015</metar>
            </origin>
            <destination>
              <icao_code>RJBB</icao_code>
              <name>Kansai</name>
              <metar>RJBB 141400Z 26015G25KT 8000 -RA BKN030 12/09 Q1009</metar>
            </destination>
            <general>
              <airline_icao>WAL</airline_icao>
              <flight_number>113</flight_number>
            </general>
            <aircraft>
              <name>A320-251N</name>
              <reg>JA123A</reg>
            </aircraft>
            <performance>
              <cruise_altitude>34000</cruise_altitude>
            </performance>
            <times>
              <est_time_enroute>01:45</est_time_enroute>
              <sched_out_zulu>14:30</sched_out_zulu>
              <sched_in_zulu>16:15</sched_in_zulu>
            </times>
          </OFP>`;

        const doc = new DOMParser().parseFromString(sampleXml,'application/xml');
        const {patch,meta} = parseSimBriefDoc(doc);

        // Apply into editor fields
        Object.entries(patch).forEach(([k,val])=>{
          const el = document.getElementById(k);
          if(el) { el.value = (typeof val === 'undefined' ? '' : val); el.dispatchEvent(new Event('input')); }
        });
        sanitizeUTCField(document.getElementById('dep_utc'));
        sanitizeUTCField(document.getElementById('arr_utc'));
        setSimBriefStatus('Sample import applied', false, true);
      }catch(e){ setSimBriefStatus('Sample import failed: '+e.message, true); }
    });

    // Flight control buttons
    bindIf('flightTakeoff', ()=>{ editorEls['flightTakeoffEpoch'].value = String(Date.now()); editorEls['flightLanded'].value = 'off'; save(); });
    bindIf('flightLanded', ()=>{ editorEls['flightLanded'].value = 'on'; save(); });

  }

  function renderInfo(d){
    const val=(k,def='')=>(d?.[k]||'').trim()||def;
    const setT=(id,val)=>{ const el=document.getElementById(id); if(el) el.textContent=val; };
    setT('i_from',val('from',DEFAULTS.from)); setT('i_to',val('to',DEFAULTS.to));
    setT('i_dep_utc',val('dep_utc',DEFAULTS.dep_utc)); setT('i_arr_utc',val('arr_utc',DEFAULTS.arr_utc));
    const frameColSaved = val('frameBorderColor', DEFAULTS.frameBorderColor);
    const frameRadiusSaved = val('frameBorderRadius', DEFAULTS.frameBorderRadius);
    try{ document.documentElement.style.setProperty('--frame-border-color', frameColSaved); document.documentElement.style.setProperty('--frame-border-radius', `${frameRadiusSaved}px`); }catch(e){}
    setT('i_flight',val('flight',DEFAULTS.flight));
    const aircraftSaved = val('aircraft', DEFAULTS.aircraft);
    const airframeSaved = val('airframe', '');
    const aircraftDisplay = airframeSaved ? `${aircraftSaved} (${airframeSaved})` : aircraftSaved;
    setT('i_aircraft', aircraftDisplay); setT('i_cruise',val('cruise',DEFAULTS.cruise));
    // flight condition display (only show dep/arr METAR summaries)
    const depMet = val('dep_metar',''); const arrMet = val('arr_metar','');

    // Airport-specific weather summaries (compact, parsed from METAR if present)
    // (parsing now done by `parseMetarSummary` helper)

    const depSummary = summarizeMetarPlain(depMet) || parseMetarSummary(depMet);
    const arrSummary = summarizeMetarPlain(arrMet) || parseMetarSummary(arrMet);
    // ensure small elements under left/right airport blocks
    const leftWrap = document.querySelector('.info-left'); const rightWrap = document.querySelector('.info-right');
    if(leftWrap){ let el = document.getElementById('i_dep_weather'); if(!el){ el=document.createElement('div'); el.id='i_dep_weather'; el.className='airport-weather'; leftWrap.appendChild(el); } el.textContent = depSummary; el.style.display = depSummary ? 'block' : 'none'; el.style.fontSize='14px'; el.style.fontWeight='700'; }
    if(rightWrap){ let el = document.getElementById('i_arr_weather'); if(!el){ el=document.createElement('div'); el.id='i_arr_weather'; el.className='airport-weather'; rightWrap.appendChild(el); } el.textContent = arrSummary; el.style.display = arrSummary ? 'block' : 'none'; el.style.fontSize='14px'; el.style.fontWeight='700'; }
    // live indicator block handled below
    // Info display toggles
    const infoLiveSaved = (val('infoLive','on') === 'on');
    const infoResSaved = (val('infoRes','on') === 'on');
    const infoPlatformSaved = (val('infoPlatform','on') === 'on');
    const resTextSaved = val('infoResText','1080p60FPS');
    const platTextSaved = val('infoPlatformText','macOS + OneCast');
    const usp=new URLSearchParams(location.search);
    const liveParam = (usp.get('infoLive')||'').toLowerCase(); const resParam = (usp.get('infoRes')||'').toLowerCase(); const platParam = (usp.get('infoPlatform')||'').toLowerCase();
    const liveShould = liveParam === 'on' ? true : liveParam === 'off' ? false : infoLiveSaved;
    const resShould = resParam === 'on' ? true : resParam === 'off' ? false : infoResSaved;
    const platShould = platParam === 'on' ? true : platParam === 'off' ? false : infoPlatformSaved;
    const liveEl=document.getElementById('i_live_block'), resEl=document.getElementById('i_res'), platEl=document.getElementById('i_platform');
    const sepEl = document.getElementById('i_sep');
    if(liveEl) liveEl.style.display = liveShould ? 'inline-flex' : 'none';
    if(resEl){ resEl.textContent = resTextSaved; resEl.style.display = resShould ? 'inline' : 'none' }
    if(platEl){ platEl.textContent = platTextSaved; platEl.style.display = platShould ? 'inline' : 'none' }
    if(sepEl) sepEl.style.display = (resShould && platShould) ? 'inline' : 'none';
    // normalize dep/arr times so they match SimBrief's parsed UTC format
    try{ const depNormalized = parseTimeUTC(val('dep_utc', DEFAULTS.dep_utc)) || val('dep_utc', DEFAULTS.dep_utc); const arrNormalized = parseTimeUTC(val('arr_utc', DEFAULTS.arr_utc)) || val('arr_utc', DEFAULTS.arr_utc); setT('i_dep_utc', depNormalized); setT('i_arr_utc', arrNormalized); }catch(e){}
    // Update flight viz (if enabled) after populating fields
    try{ renderFlightViz(d); }catch(e){}
    // METAR/ATIS fetching removed — SimBrief-sourced conditions are used instead
  }

  function parseHMToUTCDate(hmStr){
    const hm = parseHHMM(hmStr);
    if(!hm) return null;
    const now = new Date();
    return new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), hm.h, hm.m, 0));
  }

  // Parse a METAR-like string into a compact human summary
  function parseMetarSummary(m){
    if(!m) return '';
    const raw = String(m).trim();
    // wind: 24010KT or VRB03KT or 24010G20KT
    const windMatch = raw.match(/\b((?:\d{3}|VRB)\d{2,3})(G(\d{2,3}))?KT\b/);
    // visibility: 9999 or 10SM or CAVOK
    const visMatch = raw.match(/\b(\d{4}|\d+SM|CAVOK)\b/);
    // cloud layers (take most significant)
    const cloudMatch = raw.match(/\b(FEW|SCT|BKN|OVC)\d{3}\b/);
    // temperature/dewpoint pair like 09/04 or M02/M05
    const tempMatch = raw.match(/\b(M?\d{1,2})\/(M?\d{1,2})\b/);
    // altimeter Q1009 or A2992
    const qMatch = raw.match(/\b(Q\d{4})\b/);
    const aMatch = raw.match(/\b(A\d{4})\b/);
    // Build a friendly, labeled summary for viewers
    const pieces = [];
    if(windMatch){ const dirRaw = windMatch[1]; const dir = dirRaw==='VRB' ? 'Variable' : String(parseInt(dirRaw,10)); const sp = windMatch[1].replace(/VRB/,'').slice(-3).replace(/^0+/,'')||''; const gust = windMatch[3]?parseInt(windMatch[3],10):null; pieces.push(`Wind ${dir} ${sp?`${sp}kt`:''}${gust?` G${gust}kt`:''}`); }
    if(tempMatch){ const t = tempMatch[1].replace(/^M/,'-'); pieces.push(`Temp ${t}°C`); }
    if(cloudMatch){ const cls = cloudMatch[0]; const friendly = cls.replace(/^FEW/,'Few').replace(/^SCT/,'Scattered').replace(/^BKN/,'Broken').replace(/^OVC/,'Overcast'); pieces.push(`${friendly} clouds`); }
    else if(/CAVOK/i.test(raw) || /SKC|NOCLOUDS/i.test(raw)) { pieces.push('Clouds: Clear'); }
    if(visMatch){ if(/SM/i.test(visMatch[0])){ const mi = parseFloat(visMatch[1]); pieces.push(`Visibility ${Math.round(mi*1.609*10)/10} km`); } else { const v = visMatch[1]; pieces.push(v==='9999' ? 'Visibility 10 km+' : `Visibility ${v}`); } }
    if(qMatch) pieces.push(`${qMatch[1]}`); else if(aMatch) pieces.push(`${aMatch[1]}`);
    return pieces.join(' • ');
  }

  // Convert METAR/TAF-like text into a short, plain-language summary
  function summarizeMetarPlain(m){
    if(!m) return '';
    const raw = String(m).trim();
    if(!raw) return '';
    // quick checks
    if(/CAVOK/i.test(raw) || /SKC|NOCLOUDS/i.test(raw)) return 'Clear skies';
    const parts = [];
    // wind (format: 'Wind 260 15kt' and include gusts as 'G25kt')
    const windMatch = raw.match(/\b((?:\d{3}|VRB))(\d{2,3})(?:G(\d{2,3}))?KT\b/);
    if(windMatch){ const dirRaw = windMatch[1]; const dir = dirRaw === 'VRB' ? 'Variable' : String(parseInt(dirRaw,10)); const sp = parseInt(windMatch[2],10); const gust = windMatch[3]?parseInt(windMatch[3],10):null; parts.push(`Wind ${dir} ${sp}kt${gust?` G${gust}kt`:''}`); }
    // precipitation / thunderstorms
    if(/TS|TSTM/.test(raw)) parts.push('Thunderstorms');
    else if(/SHRA|SH(RA|DZ)/.test(raw)) parts.push('Showery rain');
    else if(/RA/.test(raw)) parts.push('Rain');
    else if(/SN/.test(raw)) parts.push('Snow');
    // visibility (normalize to km and use a readable unit)
    const visMatch = raw.match(/\b(\d{4})\b/) || raw.match(/\b(\d+(?:\.\d+)?)SM\b/i);
    if(visMatch){ if(/SM/i.test(visMatch[0])){ const mi = parseFloat(visMatch[1]); parts.push(`Visibility ${Math.round(mi*1.609*10)/10} km`); } else { const v = parseInt(visMatch[1],10); parts.push(v>=9999 ? 'Visibility 10 km+' : (v%1000===0?`Visibility ${v/1000} km`:`Visibility ${(v/1000).toFixed(1)} km`)); } }
    // clouds (drop altitude; keep concise)
    const cloudMatch = raw.match(/\b(FEW|SCT|BKN|OVC)(\d{3})\b/);
    if(cloudMatch){ const code = cloudMatch[1]; const friendly = code==='FEW'?'Few':code==='SCT'?'Scattered':code==='BKN'?'Broken':'Overcast'; parts.push(`${friendly} clouds`); }
    // temp
    const tempMatch = raw.match(/\b(M?\d{1,2})\/(M?\d{1,2})\b/);
    if(tempMatch){ const t=tempMatch[1].replace(/^M/,'-'); parts.push(`Temp ${t}°C`); }
    // altimeter
    const qMatch = raw.match(/\b(Q\d{4})\b/); const aMatch = raw.match(/\b(A\d{4})\b/);
    if(qMatch) parts.push(`${qMatch[1]}`); else if(aMatch) parts.push(`${aMatch[1]}`);
    // shorten and join
    const out = parts.join(' • ');
    return out.length? out : (raw.slice(0,180) + (raw.length>180? '…':''));
  }

  // Summarize enroute hazards from SimBrief OFP: search NOTAMDREC/NOTAM entries and filter by time/alt
  // Enroute summary functionality removed — only dep/arr METARs are shown

  function renderFlightViz(d){
    const container = document.getElementById('flightViz');
    if(!container) return;
    const enabled = (String(d?.flightVizEnabled||'off') === 'on');
    if(!enabled){ container.style.display='none'; return; }
    container.style.display='block';
    const dep = parseHMToUTCDate(d?.dep_utc || DEFAULTS.dep_utc);
    const arr = parseHMToUTCDate(d?.arr_utc || DEFAULTS.arr_utc);
    if(!dep || !arr){ document.getElementById('flightMeta').textContent = 'Schedule missing'; return; }
    if(arr.getTime() <= dep.getTime()) arr.setUTCDate(arr.getUTCDate()+1);
    const now = new Date();
    const takeoffEpoch = parseInt(d?.flightTakeoffEpoch||'0',10) || 0;
    const landed = (String(d?.flightLanded||'off') === 'on');
    const startTime = takeoffEpoch ? new Date(takeoffEpoch) : dep;
    const total = arr.getTime() - dep.getTime();
    const rawElapsed = now.getTime() - startTime.getTime();
    const elapsed = Math.max(0, Math.min(total, rawElapsed));
    const pct = landed ? 100 : Math.round((elapsed/total)*100);
    const posEl = document.getElementById('flightPos'); const plane = document.getElementById('flightPlane');
    posEl.style.width = Math.max(0, Math.min(100, pct)) + '%';
    // move plane (fallback: place at end if metrics unavailable)
    try{ const bar = document.getElementById('flightBar'); const rect = bar.getBoundingClientRect(); const px = (pct/100) * rect.width; plane.style.left = px + 'px'; }catch(e){}
    document.getElementById('flightFrom').textContent = d?.from || DEFAULTS.from;
    document.getElementById('flightTo').textContent = d?.to || DEFAULTS.to;
    // determine phase using SimBrief cruise altitude + enroute (if available)
    const parseEteToMinutes = (s)=>{
      if(!s) return null; const raw = String(s).replace(/^[~\s]+/,'').trim();
      const m = raw.match(/(\d+)h\s*(\d+)?m?/i);
      if(m) return parseInt(m[1],10)*60 + (m[2]?parseInt(m[2],10):0);
      const m2 = raw.match(/(\d+)m$/i);
      if(m2) return parseInt(m2[1],10);
      const num = parseInt(raw.replace(/\D/g,''),10); if(Number.isFinite(num) && num>0) return num;
      return null;
    };
    const parseCruiseFeet = (s)=>{ if(!s) return null; const m=s.toString().replace(/[,\s]/g,'').match(/(\d{3,6})/); return m?parseInt(m[1],10):null };
    const totalMins = (()=>{ const ete = parseEteToMinutes(d?.enroute||''); if(ete) return ete; const tmins = Math.round(total/60000); return tmins || null; })();
    let climbMins = null, descentMins = null;
    const cruiseFt = parseCruiseFeet(d?.cruise);
    if(cruiseFt){ const climbRate = 1500; climbMins = Math.max(2, Math.round(cruiseFt / climbRate)); descentMins = climbMins; }
    if(totalMins){ // ensure climb+descent reasonable
      const maxEdge = Math.max(2, Math.round(totalMins * 0.25));
      if(climbMins === null) climbMins = Math.max(2, Math.round(totalMins * 0.12));
      climbMins = Math.min(climbMins, maxEdge);
      descentMins = Math.min(descentMins || climbMins, maxEdge);
    }
    const elapsedMins = Math.round(elapsed/60000);
    let phase = 'Scheduled';
    if(landed) phase = 'Landed';
    else if(takeoffEpoch){
      if(elapsedMins < 1) phase = 'Takeoff';
      else if(climbMins !== null && elapsedMins < climbMins) phase = 'Climb';
      else {
        const afterClimb = elapsedMins - (climbMins||0);
        const cruiseMins = (totalMins ? Math.max(0, totalMins - (climbMins||0) - (descentMins||0)) : null);
        if(cruiseMins !== null && afterClimb < cruiseMins) phase = 'Cruise';
        else if(descentMins !== null && (totalMins - elapsedMins) <= descentMins) phase = 'Descent';
        else phase = 'Cruise';
      }
    } else { phase = (now < dep) ? 'Scheduled' : 'Boarding'; }
    const cruiseText = d?.cruise ? ` • ${d.cruise}` : '';
    const phEl = document.getElementById('flightPhase'); if(phEl) phEl.textContent = phase + cruiseText;
  }
  function renderDepartures(d){
    const val=(k,def='')=>(d?.[k]||'').trim()||def;
    const setT=(id,val)=>{ const el=document.getElementById(id); if(el) el.textContent=val; };
    setT('d_from',val('from',DEFAULTS.from)); setT('d_to',val('to',DEFAULTS.to));
    setT('d_flight',val('flight',DEFAULTS.flight)); setT('d_gate',val('gate',DEFAULTS.gate));

    const depRaw = val('dep_utc', DEFAULTS.dep_utc);
    const arrRaw = val('arr_utc', DEFAULTS.arr_utc);
    const depDisp = parseTimeUTC(depRaw) || DEFAULTS.dep_utc;
    const arrDisp = parseTimeUTC(arrRaw) || DEFAULTS.arr_utc;
    // parsed departure/arrival times for display
    setT('d_dep',depDisp); setT('d_arr',arrDisp);
    setT('d_time',(depDisp||'').replace(' UTC',''));

    const frameColSaved = val('frameBorderColor', DEFAULTS.frameBorderColor);
    const frameRadiusSaved = val('frameBorderRadius', DEFAULTS.frameBorderRadius);
    try{ document.documentElement.style.setProperty('--frame-border-color', frameColSaved); document.documentElement.style.setProperty('--frame-border-radius', `${frameRadiusSaved}px`); }catch(e){}
    const st=val('status','on-time'); const node=document.getElementById('d_status');
    if(st==='custom'){ if(node) node.className='status custom'; const txt=val('status_custom','STATUS');
      const stTxt=document.getElementById('d_status_text'); if(stTxt) stTxt.textContent=txt; return; }
    const labels={ 'on-time':'ON TIME','boarding':'BOARDING','delayed':'DELAYED','cancelled':'CANCELLED','sideways':'SIDEWAYS' };
    if(node) node.className='status '+st;
    const stTxt=document.getElementById('d_status_text'); if(stTxt) stTxt.textContent=labels[st]||st.toUpperCase();
  }

  function renderFrame(d){
    const v=(k,def)=>{ const raw=(d?.[k]??"").toString().trim(); return raw===''?def:raw; };
    const num=(k,def)=>{ const n=parseFloat(v(k, def.toString())); return Number.isNaN(n)?def:n; };
    const wcX=num('wcX',32), wcY=num('wcY',700), wcW=num('wcW',1280), wcH=num('wcH',720);
    const frameCol=v('frameBorderColor','#3d434b');
    const bCol = frameCol; const bTh=num('frameBorderWidth',6);
    const frameRadius = parseFloat(v('frameBorderRadius','28'))||28;
    const wcRadius = frameRadius; 
    try{ document.documentElement.style.setProperty('--frame-border-color', frameCol); document.documentElement.style.setProperty('--frame-border-radius', `${frameRadius}px`); }catch(e){}
    const wcShowSaved = (v('wcShow','on') === 'on');

    const usp=new URLSearchParams(location.search);
    const orNum=(k,cur)=>{ const f=parseFloat(usp.get(k)||''); return Number.isNaN(f)?cur:f; };
    const orStr=(k,cur)=> usp.get(k) ?? cur;
    const pad = orNum('pad',16), topH = orNum('topH',22), logoGap = orNum('logoGap',18);
    const matte = orStr('matte','#1d1f22');

    const holeX=pad, holeY=pad+topH, holeW=1920-pad*2, holeH=Math.max(200,1080-holeY-pad);
    const hole=document.getElementById('hole'), matteRect=document.getElementById('matteRect');
    const borderRect=document.getElementById('borderRect'), borderOutline=document.getElementById('borderOutline'), hairRect=document.getElementById('hairRect');
    [hole,borderRect,hairRect].forEach((r)=>{ if(!r) return; const inset=(r===hairRect)?10:0; r.setAttribute('x',holeX+inset); r.setAttribute('y',holeY+inset); r.setAttribute('width',holeW-inset*2); r.setAttribute('height',holeH-inset*2); });
    if(matteRect) matteRect.setAttribute('fill', matte);
    if(borderRect) { const bc = usp.get('bCol') || frameCol || ''; const bt = usp.get('bTh') || ''; if(bc) borderRect.setAttribute('stroke', bc); if(bt) borderRect.setAttribute('stroke-width', parseFloat(bt)||parseFloat(bTh)); else borderRect.setAttribute('stroke-width', parseFloat(bTh)); if(bc) borderRect.setAttribute('rx', frameRadius); if(bc) borderRect.setAttribute('ry', frameRadius); }
    if(borderOutline){ borderOutline.setAttribute('stroke', 'rgba(0,0,0,.6)'); borderOutline.setAttribute('stroke-width', '1'); if(borderOutline) borderOutline.setAttribute('rx', frameRadius); if(borderOutline) borderOutline.setAttribute('ry', frameRadius); }
    if(hole) { hole.setAttribute('rx', frameRadius); hole.setAttribute('ry', frameRadius); }
    if(hairRect){ hairRect.setAttribute('rx', frameRadius); hairRect.setAttribute('ry', frameRadius); hairRect.setAttribute('stroke', 'rgba(0,0,0,.6)'); }

    const lg=document.getElementById('frame_logo');
    if(lg){ const approxLogoH=30; const top=Math.max(8, holeY - (approxLogoH + logoGap)); lg.style.top = top+'px';
      const logoSaved = (v('logoShow','on') === 'on');
      const logoParam = (usp.get('logoShow')||'').toLowerCase();
      let logoShouldShow = logoSaved;
      if(logoParam === 'on') logoShouldShow = true; else if (logoParam === 'off') logoShouldShow = false;
      lg.style.display = logoShouldShow ? 'flex' : 'none'; }

    const wc=document.getElementById('wc');
    if(wc){ wc.style.left=(wcX+pad)+'px'; wc.style.top=wcY+'px'; wc.style.width=wcW+'px'; wc.style.height=wcH+'px'; wc.style.display='block'; wc.style.borderRadius = `${frameRadius}px`; wc.style.outline = wcShowSaved ? `${bTh}px solid ${bCol}` : 'none'; wc.style.boxShadow = wcShowSaved ? '0 0 0 1px rgba(0,0,0,.6), 0 12px 36px rgba(0,0,0,.5), inset 0 0 0 2px rgba(0,0,0,.35)' : 'none'; }
    // AFK logo handling
    const afkPath = 'afklogo.png';
    const afkOn = wcShowSaved;
    const imgEl = document.getElementById('wc_afk');
    if(imgEl){
      const wcShowParam = (usp.get('wcShow')||'').toLowerCase();
      const shouldShow = afkOn && (wcShowParam !== 'off');
      if(shouldShow){ try{ const base = location.href.split('#')[0].split('?')[0]; imgEl.src = /^[a-zA-Z]+:/.test(afkPath) ? afkPath : new URL(afkPath, base).href; }catch(e){ imgEl.src = afkPath; } imgEl.style.display = 'block'; }
      else imgEl.style.display = 'none';
    }

    const infoWrap=document.getElementById('embed_info'); const infoIframe=document.getElementById('info_iframe');
    const infoX=orNum('infoX',pad+16), infoY=orNum('infoY',holeY+6), infoScale=orNum('infoScale',1);
    if(infoWrap){ infoWrap.style.left='50%'; infoWrap.style.top=infoY+'px'; infoWrap.style.transform=`translateX(-50%) scale(${infoScale})`; infoWrap.style.display='block'; infoWrap.setAttribute('aria-hidden','false'); }
    if(infoIframe){ const base=location.href.split('#')[0]; infoIframe.src=`${base}#info:${room}`; }
  }

  function subscribe(){
    if (dbUnsub) { try{ dbUnsub(); }catch{} dbUnsub=null; }
    const r = ref(db, `rooms/${room}`);
    let lastData = null;
    let flightVizTimer = null;
    dbUnsub = onValue(r, snap=>{
      const data = snap.val() || DEFAULTS;
      lastData = data;

      if (mode==='info') renderInfo(data);
      if (mode==='departures') renderDepartures(data);
      if (mode==='frame') renderFrame(data);

      // ensure the flight visualization updates in real time while in an overlay mode
      try{ if(mode==='info' || mode==='frame'){
          if(flightVizTimer) clearInterval(flightVizTimer);
          flightVizTimer = setInterval(()=>{ try{ renderFlightViz(lastData); }catch(e){} }, 1000);
        } else { if(flightVizTimer){ clearInterval(flightVizTimer); flightVizTimer = null; } }
      }catch(e){}

      if (mode==='editor') {
        for(const k of FIELDS){
          const el=document.getElementById(k);
          if(!el) continue;
          const val = (typeof data[k]==='string') ? data[k] : DEFAULTS[k];
          if (typeof val === 'undefined') continue;
          if (el.type === 'checkbox') el.checked = (String(val) === 'on'); else el.value = val;
        }
          let windStr = null, precipStr = null, cloudStr = null, visStr = null, tempStr = null, altStr = null;
          const windMatch = raw.match(/\b((?:\d{3}|VRB))(\d{2,3})(?:G(\d{2,3}))?KT\b/);
          if(windMatch){ const dirRaw = windMatch[1]; const dir = dirRaw === 'VRB' ? 'Variable' : String(parseInt(dirRaw,10)); const sp = parseInt(windMatch[2],10); const gust = windMatch[3]?parseInt(windMatch[3],10):null; windStr = `Wind ${dir} ${sp}kt${gust?` G${gust}kt`:''}`; }
          if(/\bTS\b|\bTSTM\b/.test(raw)) precipStr = 'Thunderstorms';
          else if(/\bSHRA\b|\bSH(RA|DZ)\b/.test(raw)) precipStr = 'Showery rain';
          else if(/\bRA\b/.test(raw)) precipStr = 'Rain';
          else if(/\bSN\b/.test(raw)) precipStr = 'Snow';
          const visMatch = raw.match(/\b(\d{4})\b/) || raw.match(/\b(\d+(?:\.\d+)?)SM\b/i);
          if(visMatch){ if(/SM/i.test(visMatch[0])){ const mi = parseFloat(visMatch[1]); visStr = `${Math.round(mi*1.609*10)/10} km`; } else { const v = parseInt(visMatch[1],10); visStr = v>=9999 ? '10 km+' : (v%1000===0?`${v/1000} km`:`${(v/1000).toFixed(1)} km`); } }
          const cloudMatch = raw.match(/\b(FEW|SCT|BKN|OVC)(\d{3})\b/);
          if(cloudMatch){ const code = cloudMatch[1]; const friendly = code==='FEW'?'Few':code==='SCT'?'Scattered':code==='BKN'?'Broken':'Overcast'; cloudStr = `${friendly} clouds`; }
          const tempMatch = raw.match(/\b(M?\d{1,2})\/(M?\d{1,2})\b/);
          if(tempMatch){ const t=tempMatch[1].replace(/^M/,'-'); tempStr = `Temp ${t}°C`; }
          const qMatch = raw.match(/\b(Q\d{4})\b/); const aMatch = raw.match(/\b(A\d{4})\b/);
          if(qMatch) altStr = `${qMatch[1]}`; else if(aMatch) altStr = `${aMatch[1]}`;

          const out = [];
          if(windStr) out.push(windStr);
          if(precipStr) out.push(precipStr);
          else if(cloudStr) out.push(cloudStr);
          else if(visStr) out.push(`Visibility ${visStr}`);
          if(out.length < 3){ if(tempStr) out.push(tempStr); else if(altStr) out.push(altStr); }
          return out.join(' • ') || (raw.slice(0,180) + (raw.length>180? '…':''));
        document.body.classList.add('ready');
        firstPaint = true;
        canSave = true;
        const s = document.getElementById('inapp-splash');
        if (s) setTimeout(()=>{ s.remove(); }, 400);
      }
    }, err=>{
      setStatus(`Live data failed: ${err.message}`);
    });
  }

  function applyOverlayOptions(){
    const usp=new URLSearchParams(location.search);
    const x=parseFloat(usp.get('x')||''); const y=parseFloat(usp.get('y')||''); const s=parseFloat(usp.get('scale')||''); const onlyReal=usp.get('onlyReal');
    const place=(el)=>{ if(!el) return; if(!Number.isNaN(x)) el.style.left=x+'px'; if(!Number.isNaN(y)) el.style.top=y+'px';
      if(!Number.isNaN(s)) el.style.transform=`scale(${s})`; el.style.transformOrigin='top left'; };
    if (mode==='info') place(document.querySelector('#screen-info .info-box')?.parentElement);
    if (mode==='departures') place(document.getElementById('screen-departures'));
    if (mode==='departures' && (onlyReal==='1'||onlyReal==='true')){
      document.querySelectorAll('.table .tr').forEach(tr=>{ if(!tr.classList.contains('real') && !tr.previousElementSibling?.classList.contains('th')) tr.style.display='none'; });
    }

    if (mode==='frame'){
      const getNum=(k,d)=>{const v=parseFloat(usp.get(k)||'');return Number.isNaN(v)?d:v};
      const pad=getNum('pad',16);
      const frameRadius=getNum('frameBorderRadius',28);
      const topH=getNum('topH',22);
      const logoGap=getNum('logoGap',18);
      const matte= usp.get('matte') || '#1d1f22';
      const bTh = getNum('frameBorderWidth', 6);
      const bCol = usp.get('frameBorderColor') || DEFAULTS.frameBorderColor;

      const holeX=pad, holeY=pad+topH, holeW=1920-pad*2, holeH=Math.max(200,1080-holeY-pad);
      const hole=document.getElementById('hole'), matteRect=document.getElementById('matteRect');
      const borderRect=document.getElementById('borderRect'), borderOutline=document.getElementById('borderOutline'), hairRect=document.getElementById('hairRect');
      [hole,borderRect,borderOutline,hairRect].forEach((r)=>{ if(!r) return; const inset=(r===hairRect)?10:0; r.setAttribute('x',holeX+inset); r.setAttribute('y',holeY+inset); r.setAttribute('width',holeW-inset*2); r.setAttribute('height',holeH-inset*2); });
      if(hole){ hole.setAttribute('rx', frameRadius); hole.setAttribute('ry', frameRadius); }
      if(borderRect){ borderRect.setAttribute('rx', frameRadius); borderRect.setAttribute('ry', frameRadius); }
      if(borderOutline){ borderOutline.setAttribute('rx', frameRadius); borderOutline.setAttribute('ry', frameRadius); borderOutline.setAttribute('stroke', 'rgba(0,0,0,.6)'); borderOutline.setAttribute('stroke-width','1'); }
      if(hairRect){ hairRect.setAttribute('rx', frameRadius); hairRect.setAttribute('ry', frameRadius); hairRect.setAttribute('stroke','rgba(0,0,0,.6)'); }
      if(matteRect) matteRect.setAttribute('fill', matte);
      if(hole) { hole.setAttribute('rx', frameRadius); hole.setAttribute('ry', frameRadius); }
      if(borderRect) { borderRect.setAttribute('rx', frameRadius); borderRect.setAttribute('ry', frameRadius); }
      if(hairRect) { hairRect.setAttribute('rx', frameRadius); hairRect.setAttribute('ry', frameRadius); }

      const lg=document.getElementById('frame_logo');
      if(lg){ const approxLogoH=30; const top=Math.max(8, holeY - (approxLogoH + logoGap)); lg.style.top = top+'px';
        const logoParam=(usp.get('logoShow')||'').toLowerCase();
        if(logoParam === 'off') lg.style.display = 'none';
        else if(logoParam === 'on') lg.style.display = 'flex';
        else lg.style.display = 'flex'; }

      const wc=document.getElementById('wc');
      const wcX=getNum('wcX',32), wcY=getNum('wcY',700), wcW=getNum('wcW',1280), wcH=getNum('wcH',720);
      if(wc){ wc.style.left=(wcX+pad)+'px'; wc.style.top=wcY+'px'; wc.style.width=wcW+'px'; wc.style.height=wcH+'px'; wc.style.display='block'; wc.style.borderRadius=`${frameRadius}px`;
        const wcShowParam = (usp.get('wcShow')||'').toLowerCase(); const imgEl=document.getElementById('wc_afk');
        if(wcShowParam === 'off'){ wc.style.outline = 'none'; wc.style.boxShadow = 'none'; if(imgEl) imgEl.style.display = 'none'; }
        else if (wcShowParam === 'on'){ wc.style.outline = `${bTh}px solid ${bCol}`; wc.style.boxShadow = '0 0 0 1px rgba(0,0,0,.6), 0 12px 36px rgba(0,0,0,.5), inset 0 0 0 2px rgba(0,0,0,.35)'; if(imgEl) imgEl.style.display = 'block'; }
      }

      const infoWrap=document.getElementById('embed_info'); const infoIframe=document.getElementById('info_iframe');
      const infoX=getNum('infoX',pad+16), infoY=getNum('infoY',holeY+6), infoScale=getNum('infoScale',1);
      if(infoWrap){ infoWrap.style.left='50%'; infoWrap.style.top=infoY+'px'; infoWrap.style.transform=`translateX(-50%) scale(${infoScale})`; infoWrap.style.display='block'; infoWrap.setAttribute('aria-hidden','false'); }
      if(infoIframe){ const base=location.href.split('#')[0]; infoIframe.src=`${base}#info:${room}`; }
      // Add compact enroute/airport summaries into the frame context (fallback when iframe doesn't show them)
      try{
        const usp = new URLSearchParams(location.search);
        const enrouteTxt = '';
        const depTxt = summarizeMetarPlain(usp.get('dep_metar') || d?.dep_metar || '') || parseMetarSummary(usp.get('dep_metar') || d?.dep_metar || '');
        const arrTxt = summarizeMetarPlain(usp.get('arr_metar') || d?.arr_metar || '') || parseMetarSummary(usp.get('arr_metar') || d?.arr_metar || '');
        if(infoWrap){
          let dEl = document.getElementById('embed_dep_weather');
          if(!dEl){ dEl = document.createElement('div'); dEl.id='embed_dep_weather'; dEl.style.position='absolute'; dEl.style.left='8px'; dEl.style.top='6px'; dEl.style.fontSize='14px'; dEl.style.color='white'; dEl.style.opacity='.9'; dEl.style.pointerEvents='none'; infoWrap.appendChild(dEl); }
          dEl.textContent = depTxt || '';
          dEl.style.display = depTxt ? 'block' : 'none';

          let aEl = document.getElementById('embed_arr_weather');
          if(!aEl){ aEl = document.createElement('div'); aEl.id='embed_arr_weather'; aEl.style.position='absolute'; aEl.style.right='8px'; aEl.style.top='6px'; aEl.style.fontSize='14px'; aEl.style.color='white'; aEl.style.opacity='.9'; aEl.style.pointerEvents='none'; infoWrap.appendChild(aEl); }
          aEl.textContent = arrTxt || '';
          aEl.style.display = arrTxt ? 'block' : 'none';
        }
      }catch(e){}
    }
    // METAR/ATIS timer removed — no-op
  }

  function setStatus(msg){ const el=document.getElementById('auth_status'); if(el){ el.textContent=msg||''; } }
  function requireAuthUI(on){ document.body.classList.toggle('require-auth', !!on); }

  function bindAuthUI(){
    const emailEl = document.getElementById('auth_email');
    const passEl  = document.getElementById('auth_password');
    document.getElementById('btn_signin')?.addEventListener('click', async ()=>{
      setStatus(''); try { await signInWithEmailAndPassword(auth, (emailEl.value||'').trim(), passEl.value||''); }
      catch(e){ setStatus(e.message); }
    });
    document.getElementById('btn_signup')?.addEventListener('click', async ()=>{
      setStatus(''); try { await createUserWithEmailAndPassword(auth, (emailEl.value||'').trim(), passEl.value||''); }
      catch(e){ setStatus(e.message); }
    });
  }
  bindAuthUI();

  function updateNetBadge(){
    const b = document.getElementById('net_badge');
    if(!b) return;
    if (navigator.onLine){ b.textContent='Status: online'; b.className='pill ok'; }
    else { b.textContent='Status: offline (changes won’t sync)'; b.className='pill warn'; }
  }
  addEventListener('online',  updateNetBadge);
  addEventListener('offline', updateNetBadge);
  updateNetBadge();

  function ensureUIDRoomAndBadge(){
    const uid = signedInUser?.uid || '';
    const inBtn = document.getElementById('uid_in_btn');
    if (inBtn) inBtn.textContent = uid || '—';
    const placeholder = !room || room === 'crabroom' || room === 'me';
    if (uid && placeholder){
      room = uid;
      try { localStorage.setItem('lastRoom', room); } catch {}
      const base = location.href.split('#')[0];
      location.hash = `${mode}:${room}`;
      return;
    }
  }

  function computeUrls(){
    const targetRoom = signedInUser?.uid || room;
    const base = location.href.split('#')[0];
    const qs = location.search || '';
    return {
      info: `${base}#info:${targetRoom}${qs}`,
      dep:  `${base}#departures:${targetRoom}${qs}`,
      frame:`${base}#frame:${targetRoom}${qs}`
    };
  }
  function openUrlModal(){
    const urls = computeUrls();
    document.getElementById('url_info').value = urls.info;
    document.getElementById('url_dep').value  = urls.dep;
    const uf = document.getElementById('url_frame'); if(uf) uf.value = urls.frame;
    document.getElementById('url_modal').classList.add('open');
  }
  function closeUrlModal(){ document.getElementById('url_modal').classList.remove('open'); }
  document.getElementById('url_modal_bg')?.addEventListener('click', closeUrlModal);
  document.getElementById('close_modal')?.addEventListener('click', closeUrlModal);
  addEventListener('keydown', e=>{ if(e.key==='Escape') closeUrlModal(); });
  document.getElementById('copy_info')?.addEventListener('click', ()=> copyFrom('url_info'));
  document.getElementById('copy_dep')?.addEventListener('click', ()=> copyFrom('url_dep'));
  const cfr = document.getElementById('copy_frame'); if(cfr) cfr.addEventListener('click', ()=> copyFrom('url_frame'));
  async function copyFrom(id){
    const el = document.getElementById(id);
    if(!el) return;
    try{ await navigator.clipboard.writeText(el.value); el.nextElementSibling?.classList.add('ok'); setTimeout(()=>el.nextElementSibling?.classList.remove('ok'),800); }
    catch{ el.select(); document.execCommand('copy'); }
  }

  function bind(){
    if (mode === 'editor') {
      onAuthStateChanged(auth, (user)=>{
        signedInUser = user || null;
        editorBound = false;
        canSave = false;
        ensureUIDRoomAndBadge();
        if (!signedInUser){
          requireAuthUI(true);
          document.body.classList.add('ready');
          const s = document.getElementById('inapp-splash');
          if (s) { try { s.remove(); } catch {} }
          if (dbUnsub) { try{ dbUnsub(); }catch{} dbUnsub=null; }
        } else {
          requireAuthUI(false);
          bindEditor();
          subscribe();
        }
        applyOverlayOptions();
      });
    } else {
      subscribe();
      applyOverlayOptions();
    }
  }
  bind();

  addEventListener('keydown', (e)=>{
    if((mode==='info'||mode==='departures') && (e.key==='e'||e.key==='E')){
      const base=location.href.split('#')[0]; location.href = `${base}#editor:${room}`;
    }
  });

  if (mode === 'editor') { try { history.replaceState(null, '', '/'); } catch (e) {} }
</script>

<!-- ROOM ROUTER PATCH -->
<script type="module">
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

  const routerAuth = (() => {
    try { return getAuth(); } catch { return null; }
  })();

  const MODES = ["editor","info","departures","frame"];

  function routerParseHash() {
    const raw = (location.hash || "").slice(1);
    let [mode, room] = raw.split(":");
    if (!mode || !MODES.includes(mode)) mode = "editor";
    return { mode, room: room || null };
  }

  function setHashRoom(room) {
    const { mode } = routerParseHash();
    const target = `#${mode}:${room}`;
    if (location.hash !== target) location.replace(target);
  }

  function updateOverlayTargets(room) {
    const sel = ['a[href^="#info:"]','a[href^="#departures:"]','a[href^="#frame:"]'].join(',');
    document.querySelectorAll(sel).forEach(a => {
      const path = a.getAttribute("href").split(":")[0];
      a.setAttribute("href", `${path}:${room}`);
    });
    const f = document.querySelector('#screen-frame');
    if (f && f.src) {
      const u = new URL(f.src, location.href);
      const frag = u.hash || "#departures";
      const path = frag.split(":")[0];
      f.src = `${path.replace(/^#/, "./")}:${room}`;
    }
  }

  function disableOverlayTargets(disabled) {
    document.querySelectorAll('[data-overlay-link], a[href^="#info"], a[href^="#departures"], a[href^="#frame"]').forEach(el => {
      try { el.toggleAttribute('disabled', !!disabled); } catch {}
    });
  }

  if (!location.hash) location.replace("#editor");
  disableOverlayTargets(true);

  let resolvedRoom = null;

  function adoptRoom(room) {
    if (!room) return;
    resolvedRoom = room;
    localStorage.setItem("lastRoom", room);
    setHashRoom(room);
    updateOverlayTargets(room);
    disableOverlayTargets(false);
  }

  const last = localStorage.getItem("lastRoom");
  if (last) {
    adoptRoom(last);
  }

  if (routerAuth) {
    onAuthStateChanged(routerAuth, (user) => {
      if (user?.uid && user.uid !== resolvedRoom) {
        adoptRoom(user.uid);
      }
    });
  }

  window.addEventListener("hashchange", () => {
    const { room } = routerParseHash();
    if (resolvedRoom && room !== resolvedRoom) setHashRoom(resolvedRoom);
  });
</script>
<!-- END ROOM ROUTER PATCH -->

</body>
</html>
