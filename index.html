<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CrabbyFlight â€” Editor</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="manifest" href="manifest.json" />
  <style>
    :root {
      --bg: #1d1f22;
      --panel: #2a2d31;
      --ink: #f2f3f5;
      --muted: #b5bcc6;
      --line: #444a52;
      --radius: 12px;
      --shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
      --gap: 16px;
    }

    html, body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--ink);
      font-family: system-ui, sans-serif;
    }

    .wrap {
      max-width: 980px;
      margin: 0 auto;
      padding: 28px;
      background: var(--bg);
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 18px;
      margin: 14px 0;
      box-shadow: var(--shadow);
    }

    h1 {
      margin: 0 0 14px;
      font-size: 26px;
      font-weight: 700;
    }

    label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      margin: 6px 0;
    }

    input, select {
      width: 100%;
      background: #32363c;
      border: 1px solid #444a52;
      color: var(--ink);
      border-radius: 12px;
      padding: 10px 14px;
      height: 44px;
      box-sizing: border-box;
      outline: none;
      appearance: none;
    }

    input:focus, select:focus {
      border-color: #5b9cff;
      box-shadow: 0 0 0 3px rgba(91, 156, 255, 0.18);
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--gap);
    }

    .btns {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 14px;
    }

    button {
      border: 1px solid #454b54;
      background: #373c43;
      color: var(--ink);
      padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.15s ease, transform 0.02s ease;
    }

    button:hover {
      background: #3f454d;
    }

    button:active {
      transform: translateY(1px);
    }

    .hint {
      color: var(--muted);
      font-size: 12px;
    }

    #btnSignOut {
      margin-left: auto;
      background: #FF6B6B;
      border-color: #e65c5c;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Flight Editor</h1>
      <div class="grid">
        <div><label>Callsign</label><input id="callsign" placeholder="e.g. EZY1234" /></div>
        <div><label>From</label><input id="from" placeholder="EGKK" /></div>
        <div><label>To</label><input id="to" placeholder="LPMA" /></div>
        <div><label>Time en route</label><input id="enroute" placeholder="~2hrs" /></div>
        <div><label>LIVE</label><select id="live"><option value="on">On</option><option value="off">Off</option></select></div>
      </div>

      <div class="btns">
        <button id="openInfo">Open Info (#info)</button>
        <button id="openDep">Open Departures (#departures)</button>
        <button id="copyUrls">Copy Overlay URLs</button>
        <button id="btnSignOut">Sign out</button>
        <span class="hint">Use the same room ID. Add <code>?x</code>, <code>?y</code>, <code>?scale</code> to position overlays.</span>
      </div>
    </div>

    <div class="card">
      <div class="hint">In OBS, use <code>#info:ROOM</code> or <code>#departures:ROOM</code> in browser source.</div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBs4FN-KgUH7cQl15BFyCSLGGq-O-Ey4u0",
      authDomain: "crabbyflight.firebaseapp.com",
      projectId: "crabbyflight",
      databaseURL: "https://crabbyflight-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const el = id => document.getElementById(id);
    const inputs = ['callsign', 'from', 'to', 'enroute', 'live'];

    function hashChanged() {
      const hash = (location.hash || '').replace(/^#/, '');
      const [mode, room] = hash.split(':');
      const dataRef = ref(db, `rooms/${room}`);

      if (mode === 'editor') {
        onValue(dataRef, snap => {
          const val = snap.val() || {};
          inputs.forEach(k => { el(k).value = val[k] || ''; });
        });

        inputs.forEach(k => {
          el(k).addEventListener('input', () => {
            const obj = {};
            inputs.forEach(x => obj[x] = el(x).value);
            set(dataRef, obj);
          });
        });

        el('openInfo').addEventListener('click', () => {
          window.open(`#info:${room}`, '_blank');
        });
        el('openDep').addEventListener('click', () => {
          window.open(`#departures:${room}`, '_blank');
        });
        el('copyUrls').addEventListener('click', () => {
          const base = location.href.split('#')[0];
          const text = [
            `${base}#info:${room}`,
            `${base}#departures:${room}`
          ].join('\n');
          navigator.clipboard.writeText(text);
          alert('Overlay URLs copied!');
        });
      }

      // Overlay logic will go here (info, departures)
    }

    onAuthStateChanged(auth, (user) => {
      const raw = (location.hash || '').replace(/^#/, '');
      const [mode] = raw.split(':');

      if (!user && mode !== 'info' && mode !== 'departures') {
        localStorage.setItem('crabby-intended-hash', location.hash || '');
        location.href = 'login.html';
        return;
      }

      if (user && !location.hash) {
        location.replace(`#editor:${user.uid}`);
        return;
      }

      const intended = localStorage.getItem('crabby-intended-hash');
      if (user && intended) {
        localStorage.removeItem('crabby-intended-hash');
        if (intended.indexOf(user.uid) === -1) {
          location.replace(intended.replace(':crabroom', `:${user.uid}`));
          return;
        }
      }

      hashChanged();
    });

    const btnSignOut = document.getElementById('btnSignOut');
    if (btnSignOut) {
      btnSignOut.addEventListener('click', async () => {
        try {
          await signOut(auth);
          location.href = 'login.html';
        } catch (err) {
          alert(err.message || 'Error signing out.');
        }
      });
    }
  </script>
</body>
</html>