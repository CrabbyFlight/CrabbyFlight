<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CrabbyFlight — Editor & Overlays</title>

  <link rel="icon" type="image/png" sizes="192x192" href="logo192.png">
  <link rel="apple-touch-icon" href="logo192.png">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1d1f22">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root { --bg:#0f1115; --fg:#e5e7eb; --muted:#9aa0aa; --brand:#ffd100; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; }
    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; background:var(--bg); color:var(--fg); font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    header{ display:flex; align-items:center; gap:.75rem; padding:12px 16px; border-bottom:1px solid #1b1e25; position:sticky; top:0; background:rgba(15,17,21,.9); backdrop-filter:saturate(120%) blur(6px); }
    header img{ height:28px; }
    header .title{ font-weight:700; letter-spacing:.2px; }
    header .pill{ margin-left:auto; font-size:12px; padding:4px 8px; border-radius:999px; background:#1b1e25; color:var(--muted); }
    header .pill.ok{ color:#0a2; }
    header .pill.warn{ color:#a60; }
    header .pill.bad{ color:#a00; }
    main{ padding:16px; max-width:1100px; margin:0 auto; }
    .grid{ display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:10px; }
    .row{ display:grid; grid-template-columns:180px 1fr; align-items:center; gap:8px; padding:8px 10px; background:#12151b; border:1px solid #1b1e25; border-radius:10px; }
    input,select,button,textarea{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid #252a33; background:#0f131a; color:var(--fg); outline:none; }
    button.primary{ background:var(--brand); color:#111; border:none; font-weight:700; }
    .actions{ display:flex; flex-wrap:wrap; gap:10px; margin:12px 0 4px; }
    .muted{ color:var(--muted); font-size:12px; }
    .section{ margin-top:16px; padding-top:8px; border-top:1px dashed #1b1e25; }
    .overlay{ display:none; }
    body.info .overlay.info,
    body.departures .overlay.departures,
    body.frame .overlay.frame{ display:block; }
    body.editor .editor{ display:block; }
    .editor{ }
    .diag{ position:fixed; right:10px; bottom:10px; font-size:12px; padding:6px 10px; background:#11151c; border:1px solid #1b1e25; border-radius:10px; opacity:.9; }
    .hidden{ display:none; }
  </style>

  <script>
    // Set body class early for quick style state
    (function () {
      const raw = (location.hash || '').replace(/^#/, '');
      const mode = (raw.split(':')[0] || 'editor').toLowerCase();
      document.addEventListener('DOMContentLoaded', () => document.body.classList.add(mode || 'editor'));
    })();
  </script>
</head>
<body class="editor">
  <header>
    <img src="logo192.png" alt="CF">
    <div class="title">CrabbyFlight</div>
    <div id="net_badge" class="pill">Status: …</div>
  </header>

  <main>
    <div class="editor">
      <div class="actions">
        <button id="openInfo">Open Info</button>
        <button id="openDep">Open Departures</button>
        <button id="openFrame">Open Frame</button>
        <button id="copyUrls">Copy URLs</button>
        <button id="btn_signout">Sign out</button>
      </div>

      <div class="grid">
        <div class="row"><label for="from">From</label><input id="from" placeholder="Oslo (ENGM)"></div>
        <div class="row"><label for="to">To</label><input id="to" placeholder="Liverpool (EGGP)"></div>
        <div class="row"><label for="flight">Flight</label><input id="flight" placeholder="POR9392"></div>
        <div class="row"><label for="callsign">Callsign</label><input id="callsign" placeholder="WALL13"></div>
        <div class="row"><label for="gate">Gate</label><input id="gate" placeholder="B12"></div>
        <div class="row"><label for="status">Status</label>
          <select id="status">
            <option value="on-time">on-time</option>
            <option value="boarding">boarding</option>
            <option value="delayed">delayed</option>
            <option value="cancelled">cancelled</option>
            <option value="custom">custom</option>
          </select>
        </div>
        <div id="customRow" class="row"><label for="status_custom">Custom</label><input id="status_custom" placeholder="e.g. crew rest"></div>
        <div class="row"><label for="dep_utc">Dep (UTC)</label><input id="dep_utc" placeholder="14:30 UTC"></div>
        <div class="row"><label for="arr_utc">Arr (UTC)</label><input id="arr_utc" placeholder="16:30 UTC"></div>
        <div class="row"><label for="aircraft">Aircraft</label><input id="aircraft" placeholder="A320neo"></div>
        <div class="row"><label for="cruise">Cruise</label><input id="cruise" placeholder="35,000ft"></div>
        <div class="row"><label for="enroute">Enroute</label><input id="enroute" placeholder="~2hrs"></div>
        <div class="row"><label for="live">Live</label><input id="live" placeholder="on"></div>
        <div class="row"><label for="wcPreset">Preset</label>
          <select id="wcPreset">
            <option>1920x1080</option><option selected>1280x720</option><option>960x540</option>
            <option>640x480</option><option>352x288</option><option>320x240</option>
          </select>
        </div>
        <div class="row"><label for="wcX">Crop X</label><input id="wcX" value="32"></div>
        <div class="row"><label for="wcY">Crop Y</label><input id="wcY" value="700"></div>
        <div class="row"><label for="wcW">Crop W</label><input id="wcW" value="1280"></div>
        <div class="row"><label for="wcH">Crop H</label><input id="wcH" value="720"></div>
        <div class="row"><label for="wcBorderColor">Border</label><input id="wcBorderColor" value="#FFD100"></div>
        <div class="row"><label for="wcBorderWidth">Border px</label><input id="wcBorderWidth" value="6"></div>
      </div>

      <p class="muted section">Use the buttons above to open overlay views, or copy links for OBS.</p>
      <div id="url_modal" class="section">
        <div class="row"><label>Info URL</label><input id="url_info" readonly><button id="copy_info">Copy</button></div>
        <div class="row"><label>Departures URL</label><input id="url_dep" readonly><button id="copy_dep">Copy</button></div>
        <div class="row"><label>Frame URL</label><input id="url_frame" readonly><button id="copy_frame">Copy</button></div>
      </div>

      <div id="auth" class="section">
        <div class="row"><label for="auth_email">Email</label><input id="auth_email" autocomplete="username" inputmode="email"></div>
        <div class="row"><label for="auth_password">Password</label><input id="auth_password" type="password" autocomplete="current-password"></div>
        <div class="actions">
          <button id="btn_signin" class="primary">Sign in</button>
          <button id="btn_signup">Create account</button>
          <span id="auth_status" class="muted"></span>
        </div>
      </div>
    </div>

    <div class="overlay info"><h2>Info Overlay</h2><p class="muted">Connected to live data…</p></div>
    <div class="overlay departures"><h2>Departures Overlay</h2><p class="muted">Connected to live data…</p></div>
    <div class="overlay frame"><h2>Frame Overlay</h2><p class="muted">Connected to live data…</p></div>
  </main>

  <div id="diag" class="diag hidden"></div>

  <script type="module">
    // --- Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyBs4FN-KgUH7cQl15BFyCSLGGq-O-Ey4u0",
      authDomain: "crabbyflight.firebaseapp.com",
      databaseURL: "https://crabbyflight-default-rtdb.firebaseio.com",
      projectId: "crabbyflight",
      storageBucket: "crabbyflight.firebasestorage.app",
      messagingSenderId: "741648861487",
      appId: "1:741648861487:web:583ec0887f5ac3dce079da",
      measurementId: "G-8PZNG3Y1CE"
    };
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";
    import {
      getAuth, onAuthStateChanged, signInWithEmailAndPassword,
      createUserWithEmailAndPassword, signOut, setPersistence, browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    const app  = initializeApp(firebaseConfig);
    const db   = getDatabase(app);
    const auth = getAuth(app);

    // --- Hash & room parsing ---
    const LS_KEY = 'cf:lastRoom';
    function initialHash() {
      if (location.hash) return;
      const stored = localStorage.getItem(LS_KEY);
      location.replace(`#editor:${stored || 'me'}`);
    }
    initialHash();

    function parseHash(){
      const raw = (location.hash||'').replace(/^#/, '');
      const [mode, room] = raw.split(':');
      return { mode: (mode||'editor').toLowerCase(), room: room||'me' };
    }
    let { mode, room } = parseHash();
    function applyMode(){
      document.body.classList.remove('editor','info','departures','frame');
      document.body.classList.add(mode);
    }
    applyMode();

    let signedInUser = null;
    const resolveRoom = () => (room === 'me' ? (signedInUser?.uid || null) : room);

    addEventListener('hashchange', ()=>{
      ({mode, room}=parseHash());
      localStorage.setItem(LS_KEY, room);
      applyMode();
      subscribe();
      renderDiag();
    });

    // --- Fields ---
    const FIELDS = ["from","to","flight","callsign","gate","status","status_custom","dep_utc","arr_utc","aircraft","cruise","enroute","live",
      "wcPreset","wcX","wcY","wcW","wcH","wcBorderColor","wcBorderWidth"];
    const DEFAULTS = { from:"Oslo (ENGM)", to:"Liverpool (EGGP)", flight:"POR9392", callsign:"WALL13", gate:"B12",
      status:"on-time", status_custom:"", dep_utc:"14:30 UTC", arr_utc:"16:30 UTC",
      aircraft:"A320neo", cruise:"35,000ft", enroute:"~2hrs", live:"on",
      wcPreset:"1280x720", wcX:"32", wcY:"700", wcW:"1280", wcH:"720", wcBorderColor:"#FFD100", wcBorderWidth:"6" };

    // --- Editor binding ---
    let canSave=false, editorBound=false, dbUnsub=null;
    function byId(id){ return document.getElementById(id); }
    function setStatus(msg){ const el=byId('auth_status'); if(el) el.textContent=msg||''; }

    function bindEditor(){
      if (editorBound) return;
      editorBound = true;
      const els = Object.fromEntries(FIELDS.map(id=>[id, byId(id)]));

      function read(){ const d={}; for(const k of FIELDS){ d[k] = (els[k]?.value||'').trim(); } return d; }

      let t=null;
      function save(){
        if (!signedInUser || !canSave) return;
        const r = resolveRoom(); if (!r) return;
        clearTimeout(t);
        t = setTimeout(()=> set(ref(db, `rooms/${r}`), read()).catch(e=>setStatus(e.message)), 150);
      }
      for(const k of FIELDS){ const el=els[k]; if(!el) continue; el.addEventListener('input',save); el.addEventListener('change',save); }

      const statusEl = els['status']; const customRow = byId('customRow');
      function toggleCustom(){ if(customRow) customRow.style.display = (statusEl?.value==='custom') ? 'grid' : 'none'; }
      if (statusEl){ statusEl.addEventListener('change', toggleCustom); toggleCustom(); }

      byId('openInfo').onclick = ()=> window.open(computeUrls().info, '_blank','noopener');
      byId('openDep').onclick  = ()=> window.open(computeUrls().dep, '_blank','noopener');
      byId('openFrame').onclick= ()=> window.open(computeUrls().frame, '_blank','noopener');
      byId('copyUrls').onclick = ()=> openUrlModal();
      byId('btn_signout').onclick = ()=> signOut(auth).catch(e=>setStatus(e.message));
      byId('copy_info').onclick = ()=> copyFrom('url_info');
      byId('copy_dep').onclick  = ()=> copyFrom('url_dep');
      byId('copy_frame').onclick= ()=> copyFrom('url_frame');
    }

    async function copyFrom(id){
      const el=byId(id); if(!el) return;
      try{ await navigator.clipboard.writeText(el.value); }catch{ el.select(); document.execCommand('copy'); }
    }

    function computeUrls(){
      const r = resolveRoom();
      const base = location.href.split('#')[0];
      const qs = location.search || '';
      return {
        info: `${base}#info:${r}${qs}`,
        dep:  `${base}#departures:${r}${qs}`,
        frame:`${base}#frame:${r}${qs}`
      };
    }

    function openUrlModal(){
      const urls = computeUrls();
      byId('url_info').value = urls.info;
      byId('url_dep').value  = urls.dep;
      byId('url_frame').value= urls.frame;
    }

    // --- Subscribe & render ---
    function subscribe(){
      if (dbUnsub) { try{ dbUnsub(); }catch{} dbUnsub=null; }
      const r = resolveRoom();
      if (!r) { setStatus('Sign in to resolve room “me”.'); return; }
      dbUnsub = onValue(ref(db, `rooms/${r}`), snap=>{
        const data = snap.val() || DEFAULTS;
        if (mode==='editor'){
          for(const k of FIELDS){ const el=byId(k); if(el && typeof data[k] !== 'undefined') el.value = data[k]; }
          canSave = true;
          const urls = computeUrls();
          byId('url_info').value = urls.info;
          byId('url_dep').value  = urls.dep;
          byId('url_frame').value= urls.frame;
        }
        renderDiag();
      }, err=> setStatus(err.message));
    }

    // --- Overlay placeholders (your existing DOM renderers can replace these) ---
    function renderDiag(){
      const el = byId('diag');
      const r = resolveRoom();
      el.innerHTML = `mode=${mode} · room=${room} · resolved=${r||'∅'} · ${signedInUser?'auth:yes':'auth:no'}`;
      el.classList.remove('hidden');
    }

    // --- Auth ---
    function bindAuthUI(){
      byId('btn_signin').onclick = async ()=>{
        setStatus('');
        try { await signInWithEmailAndPassword(auth, (byId('auth_email').value||'').trim(), byId('auth_password').value||''); }
        catch(e){ setStatus(e.message); }
      };
      byId('btn_signup').onclick = async ()=>{
        setStatus('');
        try { await createUserWithEmailAndPassword(auth, (byId('auth_email').value||'').trim(), byId('auth_password').value||''); }
        catch(e){ setStatus(e.message); }
      };
    }
    bindAuthUI();

    function updateNetBadge(){
      const b = byId('net_badge');
      if (navigator.onLine){ b.textContent='Status: online'; b.className='pill ok'; }
      else { b.textContent='Status: offline (changes won’t sync)'; b.className='pill warn'; }
    }
    addEventListener('online',  updateNetBadge);
    addEventListener('offline', updateNetBadge);
    updateNetBadge();

    async function boot(){
      try { await setPersistence(auth, browserLocalPersistence); } catch {}
      onAuthStateChanged(auth, (user)=>{
        signedInUser = user || null;
        if (mode==='editor'){ bindEditor(); }
        subscribe();
        renderDiag();
      });
      addEventListener('keydown', (e)=>{
        if((mode==='info'||mode==='departures') && (e.key==='e'||e.key==='E')){
          const base=location.href.split('#')[0]; location.href = `${base}#editor:${room}`;
        }
      });
    }
    boot();
  </script>
</body>
</html>
